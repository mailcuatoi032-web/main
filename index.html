<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• chuy·ªÉn ƒë·ªïi h√≥a ƒë∆°n ƒëi·ªán t·ª≠</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* CSS ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u h√≥a - gi·ªØ nguy√™n nh∆∞ trong m√£ g·ªëc */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4a6ee0 0%, #6a4ca6 100%);
            color: white;
            padding: 35px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="%23ffffff" opacity="0.1"><polygon points="0,0 1000,50 1000,100 0,100"/></svg>');
            background-size: cover;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 3px solid #4a6ee0;
            margin-bottom: 25px;
            flex-wrap: wrap;
            background: #f8f9ff;
            border-radius: 12px 12px 0 0;
            padding: 5px;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            border-radius: 8px;
            margin-right: 5px;
            font-weight: 600;
            transition: all 0.3s;
            margin-bottom: 5px;
            color: #555;
            position: relative;
            overflow: hidden;
        }
        
        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4a6ee0 0%, #6a4ca6 100%);
            transition: left 0.3s;
            z-index: -1;
        }
        
        .tab.active {
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 110, 224, 0.3);
        }
        
        .tab.active::before {
            left: 0;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .upload-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #eef1ff 100%);
            border: 3px dashed #4a6ee0;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 25px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .upload-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(74, 110, 224, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
        }
        
        .upload-section:hover::before {
            transform: rotate(45deg) translate(50%, 50%);
        }
        
        .upload-section:hover {
            border-color: #6a4ca6;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(74, 110, 224, 0.15);
        }
        
        .file-input-wrapper {
            margin: 25px 0;
        }
        
        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #4a6ee0 0%, #6a4ca6 100%);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(74, 110, 224, 0.3);
        }
        
        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 110, 224, 0.4);
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 8px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4a6ee0 0%, #6a4ca6 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(74, 110, 224, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(74, 110, 224, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
        }
        
        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.4);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            background: #f8f9ff;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a6ee0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .link-area {
            display: none;
            margin-top: 25px;
            padding: 25px;
            background: linear-gradient(135deg, #e7f5e9 0%, #d4edda 100%);
            border-radius: 15px;
            border: 2px solid #c3e6cb;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .link-area h3 {
            color: #155724;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .link-box {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            cursor: text;
            user-select: all;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .link-box:hover {
            border-color: #4a6ee0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 110, 224, 0.15);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 25px 0;
        }
        
        .copy-btn, .open-btn {
            flex: 1;
            min-width: 140px;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .copy-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .copy-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }
        
        .copy-btn.copied {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
        }
        
        .open-btn {
            background: linear-gradient(135deg, #4a6ee0 0%, #6a4ca6 100%);
            color: white;
            text-decoration: none;
        }
        
        .open-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(74, 110, 224, 0.3);
        }
        
        .info-box {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffeaa7;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }
        
        .info-box h4 {
            color: #856404;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            padding: 15px;
            background: rgba(255,255,255,0.7);
            border-radius: 10px;
            border-left: 4px solid #4a6ee0;
        }
        
        .info-label {
            font-weight: 600;
            color: #4a6ee0;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }
        
        .info-value {
            color: #2c3e50;
            font-size: 1.05rem;
            font-weight: 600;
        }
        
        .status-message {
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
            animation: slideIn 0.3s ease;
            font-weight: 600;
        }
        
        .status-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .instructions {
            background: linear-gradient(135deg, #e7f3ff 0%, #d6e4ff 100%);
            border-left: 5px solid #4a6ee0;
            padding: 20px;
            border-radius: 0 12px 12px 0;
            margin-top: 25px;
        }
        
        .instructions h4 {
            color: #4a6ee0;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ol {
            padding-left: 25px;
        }
        
        .instructions li {
            margin-bottom: 12px;
            color: #555;
            line-height: 1.6;
        }
        
        .file-info {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 10px;
            font-size: 0.95rem;
            color: #666;
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            display: none;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 0.5s ease-in-out;
        }
        
        .module-misa {
            background: linear-gradient(135deg, #4a6ee0 0%, #6a4ca6 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(74, 110, 224, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .module-misa::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
        }
        
        .module-misa h3 {
            margin-bottom: 15px;
            font-size: 1.6rem;
            font-weight: 700;
        }
        
        .module-misa .module-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            margin-top: 15px;
            backdrop-filter: blur(10px);
        }
        
        .file-upload-area {
            border: 3px dashed #4a6ee0;
            border-radius: 20px;
            padding: 50px 30px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #fafbfc 0%, #f8f9ff 100%);
            position: relative;
            overflow: hidden;
        }
        
        .file-upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(74, 110, 224, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
        }
        
        .file-upload-area:hover::before {
            transform: rotate(45deg) translate(50%, 50%);
        }
        
        .file-upload-area:hover {
            border-color: #6a4ca6;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(74, 110, 224, 0.15);
        }
        
        .file-upload-area.dragover {
            border-color: #4a6ee0;
            background: #f0f4ff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
            color: #4a6ee0;
            filter: drop-shadow(0 5px 10px rgba(74, 110, 224, 0.3));
        }
        
        .invoice-details-misa {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #ffc107;
            margin-top: 20px;
            display: none;
            animation: slideUp 0.5s ease;
        }
        
        .invoice-details-misa h5 {
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1rem;
            padding: 8px 0;
            border-bottom: 1px solid rgba(133, 100, 4, 0.2);
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            color: #856404;
        }
        
        .detail-value {
            color: #2c3e50;
            font-weight: 700;
        }
        
        .processing-misa {
            display: none;
            text-align: center;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        
        .spinner-misa {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a6ee0;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        .smart-download-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #90caf9;
        }
        
        .download-option {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 5px solid #4a6ee0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .download-option h5 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option-badge {
            background: linear-gradient(135deg, #4a6ee0 0%, #6a4ca6 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .option-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }
        
        .pdf-download-btn, .direct-pdf-link, .direct-lookup-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #4a6ee0 0%, #6a4ca6 100%);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(74, 110, 224, 0.3);
            border: none;
            cursor: pointer;
        }
        
        .pdf-download-btn:hover, .direct-pdf-link:hover, .direct-lookup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 110, 224, 0.4);
        }
        
        .provider-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 8px;
        }
        
        .lookup-form {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: #4a6ee0;
            box-shadow: 0 0 0 3px rgba(74, 110, 224, 0.1);
            outline: none;
        }
        
        .provider-info, .lookup-result {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #4a6ee0;
        }
        
        .lookup-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left-color: #28a745;
        }
        
        .lookup-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-left-color: #dc3545;
        }
        
        .direct-lookup-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
        }
        
        .direct-pdf-info {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .provider-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .provider-table th {
            background: #4a6ee0;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .provider-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .provider-table tr:hover {
            background: #f8f9ff;
        }
        
        .provider-link {
            color: #4a6ee0;
            text-decoration: none;
            font-weight: 600;
        }
        
        .provider-link:hover {
            text-decoration: underline;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .api-loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #fff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        
        .module-bkav {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(44, 62, 80, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .module-bkav::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
        }
        
        .module-bkav h3 {
            margin-bottom: 15px;
            font-size: 1.6rem;
            font-weight: 700;
        }
        
        .module-bkav .module-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            margin-top: 15px;
            backdrop-filter: blur(10px);
        }
        
        .xml-input-container {
            margin-bottom: 25px;
        }
        
        .xml-input {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        .xml-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .validation-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .validation-success {
            background: #d5f4e6;
            color: #27ae60;
            border: 2px solid #27ae60;
        }
        
        .validation-error {
            background: #fadbd8;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }
        
        .file-upload-bkav {
            position: relative;
            margin-bottom: 15px;
        }
        
        .file-upload-bkav-input {
            width: 100%;
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload-bkav-input:hover {
            background: #e3f2fd;
        }
        
        .file-upload-bkav-input input {
            display: none;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ready {
            background: #27ae60;
        }
        
        .status-warning {
            background: #f39c12;
        }
        
        .status-error {
            background: #e74c3c;
        }
        
        .bkav-result-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border-left: 5px solid #3498db;
            display: none;
        }
        
        .bkav-download-link {
            display: block;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #3498db;
            color: #3498db;
            text-decoration: none;
            word-break: break-all;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .bkav-download-link:hover {
            background: #e3f2fd;
            border-color: #2980b9;
        }
        
        .bkav-link-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
            margin-top: 15px;
        }
        
        .bkav-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #d5dbdb;
        }
        
        .bkav-info-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .bkav-info-label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .bkav-info-value {
            color: #27ae60;
            font-family: 'Courier New', monospace;
        }
        
        .msttcgp-footer {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 30px;
            border-radius: 0 0 15px 15px;
        }
        
        .msttcgp-footer h4 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .msttcgp-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .msttcgp-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .msttcgp-module {
            background: rgba(52, 152, 219, 0.3);
            border-left: 4px solid #3498db;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            position: relative;
            background: white;
            margin: 0 auto;
            max-width: 800px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border-radius: 15px;
            overflow: hidden;
            animation: modalSlideIn 0.4s ease;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 20px 25px;
            background: linear-gradient(135deg, #4a6ee0 0%, #6a4ca6 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.6em;
            margin: 0;
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .modal-body {
            padding: 0;
        }
        
        .modal-footer {
            padding: 20px 25px;
            background: #f8f9ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #dee2e6;
        }
        
        /* H√≥a ƒë∆°n GTGT Styles v·ªõi l·ªÅ 1.5cm v√† font 10pt - C·∫¨P NH·∫¨T TEMPLATE M·ªöI */
        .invoice-gtgt-container {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            background: white;
            font-family: "Times New Roman", Times, serif;
            font-size: 10pt;
            color: #000000;
            position: relative;
            padding: 15mm 15mm 15mm 15mm;
            page-break-after: always;
            box-sizing: border-box;
            /* H√¨nh n·ªÅn ch√¨m cho h√≥a ƒë∆°n - ƒê√É ƒêI·ªÄU CH·ªàNH ƒê·ªò T∆Ø∆†NG PH·∫¢N */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><rect width="200" height="200" fill="%23f5f5f5" opacity="0.1"/><text x="100" y="100" font-family="Arial" font-size="20" text-anchor="middle" fill="%23000000" opacity="0.05">H√ìA ƒê∆†N ƒêI·ªÜN T·ª¨</text></svg>');
            background-repeat: repeat;
            background-position: center;
            background-size: 200px 200px;
            border: 1px solid #cccccc;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .invoice-gtgt-box-large {
            margin-left: auto;
            margin-right: auto;
            border-collapse: collapse;
            padding: 5px;
            border: 1px solid #000000;
            width: 100%;
            color: #000000;
        }
        
        .invoice-gtgt-box-small {
            border-collapse: collapse;
            padding: 5px;
            border: 1px solid #000000;
            color: #000000;
        }
        
        .invoice-gtgt-label-normal {
            padding: 2px;
            color: #000000;
        }
        
        .invoice-gtgt-label-italic {
            padding: 2px;
            font-style: italic;
            color: #000000;
        }
        
        .invoice-gtgt-label-bold {
            font-weight: bold;
            padding: 2px;
            color: #000000;
        }
        
        .invoice-gtgt-item-normal {
            font-weight: normal;
            padding: 2px;
            color: #000000;
        }
        
        .invoice-gtgt-item-bold {
            font-weight: bold;
            padding: 2px;
            color: #000000;
        }
        
        .invoice-gtgt-border-bottom {
            border-bottom: 2px solid #000000;
        }
        
        .invoice-gtgt-text-center {
            text-align: center;
        }
        
        .invoice-gtgt-text-right {
            text-align: right;
        }
        
        .invoice-gtgt-width-100 {
            width: 100%;
        }
        
        .invoice-gtgt-vertical-top {
            vertical-align: top;
        }
        
        .invoice-gtgt-no-border {
            border: none !important;
        }
        
        .page-number {
            position: absolute;
            bottom: 15mm;
            right: 15mm;
            font-size: 10pt;
            color: #000000;
            font-weight: bold;
        }

        /* Container cho ·∫£nh ch·ª•p */
        .capture-container {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 210mm;
            background: white;
            font-family: "Times New Roman", Times, serif !important;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><rect width="200" height="200" fill="%23f5f5f5" opacity="0.1"/><text x="100" y="100" font-family="Arial" font-size="20" text-anchor="middle" fill="%23000000" opacity="0.05">H√ìA ƒê∆†N ƒêI·ªÜN T·ª¨</text></svg>');
            background-repeat: repeat;
            background-position: center;
            background-size: 200px 200px;
        }

        .force-times-new-roman {
            font-family: "Times New Roman", Times, serif !important;
        }

        /* Pagination controls */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 10px;
        }
        
        .pagination-btn {
            padding: 8px 16px;
            background: #4a6ee0;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .pagination-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .page-info {
            font-weight: 600;
            color: #4a6ee0;
        }

        /* Print styles for multi-page */
        @media print {
            .invoice-gtgt-container {
                page-break-after: always;
                margin: 0;
                padding: 15mm;
                width: 100%;
                height: 297mm;
            }
            
            .invoice-gtgt-container:last-child {
                page-break-after: auto;
            }
        }

        /* Invoice Preview Styles */
        .invoice-preview {
            background: white;
            border: 2px solid #eef1ff;
            border-radius: 15px;
            padding: 30px;
            margin-top: 25px;
            display: none;
        }

        .processing-status {
            text-align: center;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 15px;
            margin: 20px 0;
            display: none;
        }

        .progress-container {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            width: 0%;
            height: 20px;
            background: linear-gradient(135deg, #4a6ee0 0%, #6a4ca6 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Footer styles for invoice */
        .footer {
            margin-top: 10px;
            padding: 10px;
            border-top: 1px solid #000;
            font-size: 9pt;
            text-align: center;
        }
        
        .cqt-info {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #000;
            background: #f9f9f9;
        }
        
        .cqt-code {
            font-weight: bold;
            font-size: 10pt;
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .upload-section {
                padding: 25px 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-bottom: 5px;
                border-radius: 8px;
            }

            .invoice-gtgt-container {
                width: 100%;
                padding: 10mm;
            }
        }
        
        .btn:disabled, .btn:disabled:hover {
            background: #6c757d !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
            opacity: 0.6;
        }
        
        .direct-pdf-link.disabled, .direct-lookup-btn.disabled {
            background: #6c757d !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>C√¥ng c·ª• chuy·ªÉn ƒë·ªïi h√≥a ƒë∆°n ƒëi·ªán t·ª≠</h1>
            <p>Chuy·ªÉn ƒë·ªïi file XML h√≥a ƒë∆°n ƒëi·ªán t·ª≠ sang PDF v√† t·∫°o link t·∫£i PDF</p>
        </div>
        
        <div class="main-content">
            <div class="tabs">
                <div class="tab active" data-tab="invoice-gtgt">H√≥a ƒë∆°n GTGT</div>
                <div class="tab" data-tab="invoice-lookup" id="lookup-tab">üîç Tra c·ª©u h√≥a ƒë∆°n</div>
            </div>
            
            <!-- Tab 1: H√≥a ƒë∆°n GTGT -->
            <div class="tab-content active" id="invoice-gtgt">
                <div class="upload-section">
                    <h3>T·∫£i l√™n file XML h√≥a ƒë∆°n</h3>
                    <p>S·ª≠ d·ª•ng m·∫´u h√≥a ƒë∆°n GTGT chuy√™n nghi·ªáp v·ªõi font Times New Roman v√† l·ªÅ 1.5cm</p>
                    <div class="file-input-wrapper">
                        <input type="file" id="xmlFileGtgt" accept=".xml" style="display: none;">
                        <label for="xmlFileGtgt" class="file-input-label">
                            <span>üìÅ Ch·ªçn file XML</span>
                        </label>
                    </div>
                    <p id="fileNameGtgt" style="margin: 15px 0; color: #666;"></p>
                    <button id="uploadBtnGtgt" class="btn btn-primary">T·∫£i l√™n v√† Xem tr∆∞·ªõc</button>
                    <button id="requestOriginalBtn" class="btn btn-warning" style="display: none;">üìã Y√™u c·∫ßu h√≥a ƒë∆°n g·ªëc</button>
                </div>
                
                <div class="loading" id="loadingGtgt">
                    <div class="spinner"></div>
                    <p>ƒêang x·ª≠ l√Ω file XML...</p>
                </div>
                
                <div id="invoicePreviewGtgt" class="invoice-preview">
                    <div class="pagination-controls">
                        <button id="prevPageBtn" class="pagination-btn" disabled>Trang tr∆∞·ªõc</button>
                        <span class="page-info" id="pageInfo">Trang 1 / 1</span>
                        <button id="nextPageBtn" class="pagination-btn" disabled>Trang ti·∫øp</button>
                    </div>
                    
                    <div class="preview-content" id="previewContentGtgt"></div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button id="showModalBtnGtgt" class="btn btn-warning">üëÅÔ∏è Xem H√≥a ƒê∆°n ƒê·∫ßy ƒê·ªß</button>
                        <button id="downloadPdfGtgt" class="btn btn-success">üì• T·∫£i v·ªÅ PDF</button>
                    </div>
                </div>
                
                <!-- Processing Status for PDF Generation -->
                <div id="pdfProcessingStatus" class="processing-status" style="display: none;">
                    <h4>ƒêang t·∫°o PDF...</h4>
                    <div class="progress-container">
                        <div class="progress-bar" id="pdfProgressBar">0%</div>
                    </div>
                    <p id="pdfStatusMessage">ƒêang x·ª≠ l√Ω...</p>
                </div>
            </div>
            
            <!-- Tab 2: Tra c·ª©u h√≥a ƒë∆°n -->
            <div class="tab-content" id="invoice-lookup">
                <div class="upload-section">
                    <h3>üîç Tra C·ª©u H√≥a ƒê∆°n</h3>
                    <p>T√¨m ki·∫øm v√† t·∫£i h√≥a ƒë∆°n PDF t·ª´ c√°c nh√† cung c·∫•p d·ªãch v·ª•</p>
                    
                    <div class="instructions">
                        <h4>üìù H∆∞·ªõng D·∫´n Tra C·ª©u H√≥a ƒê∆°n</h4>
                        <ol>
                            <li><strong>Ch·ªçn nh√† cung c·∫•p</strong> d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠</li>
                            <li>Nh·∫≠p <strong>m√£ tra c·ª©u</strong> n·∫øu c√≥ (t√¨m trong file XML)</li>
                            <li>Click <strong>"Tra c·ª©u"</strong> ƒë·ªÉ t√¨m h√≥a ƒë∆°n</li>
                            <li>H·ªá th·ªëng s·∫Ω hi·ªÉn th·ªã c√°c ph∆∞∆°ng √°n t·∫£i PDF ph√π h·ª£p</li>
                            <li>Ch·ªçn ph∆∞∆°ng √°n t·∫£i PDF ph√π h·ª£p v·ªõi nh√† cung c·∫•p</li>
                        </ol>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-primary" id="openLookupModalBtn">üîç M·ªü C√¥ng C·ª• Tra C·ª©u</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer hi·ªÉn th·ªã MSTTCGP -->
        <div class="msttcgp-footer">
            <h4>üìã DANH S√ÅCH M√É S·ªê THU·∫æ T·ªî CH·ª®C CUNG C·∫§P D·ªäCH V·ª§ H√ìA ƒê∆†N ƒêI·ªÜN T·ª¨</h4>
            <div class="msttcgp-list" id="msttcgpList">
                <!-- Danh s√°ch MSTTCGP s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
            </div>
            <!-- V√πng hi·ªÉn th·ªã link tra c·ª©u -->
            <div id="footerLookupInfo" style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <h5>üîó Link Tra C·ª©u H√≥a ƒê∆°n</h5>
                <p id="footerLookupLink">Ch∆∞a c√≥ link tra c·ª©u. H√£y s·ª≠ d·ª•ng c√¥ng c·ª• tra c·ª©u ƒë·ªÉ t·∫°o link.</p>
            </div>
        </div>
    </div>

    <!-- Modal Hi·ªÉn Th·ªã H√≥a ƒê∆°n GTGT -->
    <div class="modal-overlay" id="invoiceModalGtgt">
        <div class="modal-content">
            <div class="modal-header">
                <h2>H√≥a ƒê∆°n Gi√° Tr·ªã Gia TƒÉng</h2>
                <button class="close-btn" id="closeModalBtnGtgt">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalInvoiceContentGtgt"></div>
            </div>
            <div class="modal-footer">
                <div>
                    <button id="printInvoiceBtnGtgt" class="btn btn-primary">üñ®Ô∏è In H√≥a ƒê∆°n</button>
                    <button id="downloadModalPdfBtnGtgt" class="btn btn-success">üì• T·∫£i PDF</button>
                </div>
                <button id="closeModalBtn2Gtgt" class="btn">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Modal Tra C·ª©u H√≥a ƒê∆°n -->
    <div class="modal-overlay" id="lookupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîç Tra C·ª©u H√≥a ƒê∆°n</h2>
                <button class="close-btn" id="closeLookupModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="quick-lookup">Tra C·ª©u Nhanh</div>
                    <div class="tab" data-tab="provider-list">Danh S√°ch Nh√† Cung C·∫•p</div>
                </div>
                
                <div class="tab-content active" id="quick-lookup">
                    <div class="lookup-form">
                        <div class="form-group">
                            <label for="providerSelect">Ch·ªçn nh√† cung c·∫•p:</label>
                            <select id="providerSelect" class="form-control">
                                <option value="">-- Ch·ªçn nh√† cung c·∫•p --</option>
                                <!-- C√°c nh√† cung c·∫•p s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                            </select>
                            <div id="providerLoading" style="display: none;">
                                <small>ƒêang t·∫£i th√¥ng tin nh√† cung c·∫•p... <span class="api-loading"></span></small>
                            </div>
                        </div>
                        
                        <!-- TH√îNG TIN H√ìA ƒê∆†N T·ª™ XML - ƒê√É ƒê∆Ø·ª¢C TH√äM -->
                        <div id="invoiceInfoFromXml" class="provider-info" style="display: none;">
                            <h4>üìã Th√¥ng tin h√≥a ƒë∆°n t·ª´ XML</h4>
                            <div class="info-grid" id="invoiceInfoDetails">
                                <!-- Th√¥ng tin s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                            </div>
                        </div>

                        <div id="directPdfInfo" class="direct-pdf-info" style="display: none;">
                            <!-- Th√¥ng tin t·∫£i PDF tr·ª±c ti·∫øp s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                        </div>

                        <div class="form-group" id="lookupCodeGroup">
                            <label for="lookupCode">M√£ tra c·ª©u (n·∫øu c√≥):</label>
                            <input type="text" id="lookupCode" class="form-control" placeholder="Nh·∫≠p m√£ tra c·ª©u h√≥a ƒë∆°n (kh√¥ng b·∫Øt bu·ªôc)">
                            <small style="color: #666;">M·ªôt s·ªë nh√† cung c·∫•p kh√¥ng y√™u c·∫ßu m√£ tra c·ª©u</small>
                        </div>
                        
                        <button id="performLookupBtn" class="btn btn-primary">üîç Tra c·ª©u</button>
                        
                        <div id="providerDetails" class="provider-info" style="display: none;">
                            <!-- Th√¥ng tin nh√† cung c·∫•p s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                        </div>
                        
                        <div id="lookupResult" class="lookup-result">
                            <!-- K·∫øt qu·∫£ tra c·ª©u s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                        </div>
                        
                        <div id="directLookupSection" class="direct-lookup-section" style="display: none;">
                            <!-- Ph·∫ßn tra c·ª©u tr·ª±c ti·∫øp s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="provider-list">
                    <div class="lookup-form">
                        <div class="search-box">
                            <input type="text" id="providerSearch" placeholder="üîç T√¨m ki·∫øm nh√† cung c·∫•p...">
                        </div>
                        <div id="providerTableContainer">
                            <!-- B·∫£ng danh s√°ch nh√† cung c·∫•p s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeLookupModalBtn2" class="btn">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Container ·∫©n ƒë·ªÉ ch·ª•p ·∫£nh -->
    <div id="captureContainer" class="capture-container"></div>

    <script>
        // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu h√≥a ƒë∆°n
        let invoiceData = {};
        let matchedProviders = [];
        let currentSelectedProvider = null;
        
        // Bi·∫øn l∆∞u tr·ªØ link tra c·ª©u hi·ªán t·∫°i
        let currentLookupLink = '';
        
        // Function Vƒ©nh Hy - MSTTCGP 0314743623
        const VIENH_HY_FUNCTION = {
            mst: "0314743623",
            name: "C√¥ng ty TNHH C√¥ng ngh·ªá Vƒ©nh Hy",
            shortName: "Vƒ©nh Hy",
            apiBaseUrl: "https://ehoadondientu.com",
            pdfGeneratorUrl: "https://ehoadondientu.com/Account/GenerateFile.aspx",
            lookupUrl: "https://ehoadondientu.com/Tra-cuu",
            functionName: "Vƒ©nh Hy PDF Function",
            
            // H√†m x·ª≠ l√Ω XML cho Vƒ©nh Hy
            processXml: function(xmlContent) {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                    
                    // Check for XML parsing errors
                    if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                        return {
                            success: false,
                            error: "XML kh√¥ng h·ª£p l·ªá"
                        };
                    }
                    
                    // Extract required data
                    const sellerTaxCode = xmlDoc.querySelector('NBan > MST')?.textContent;
                    const transactionId = xmlDoc.querySelector('DLHDon')?.getAttribute('Id');
                    
                    if (!sellerTaxCode || !transactionId) {
                        return {
                            success: false,
                            error: "Kh√¥ng t√¨m th·∫•y th√¥ng tin c·∫ßn thi·∫øt trong XML"
                        };
                    }
                    
                    // ƒê·ªãnh d·∫°ng ID theo chu·∫©n Vƒ©nh Hy
                    const formattedId = this.formatInvoiceIdForLink(transactionId, sellerTaxCode);
                    const pdfUrl = `${this.pdfGeneratorUrl}?r=${formattedId}&type=pdf`;
                    
                    return {
                        success: true,
                        data: {
                            sellerTaxCode: sellerTaxCode,
                            transactionId: transactionId,
                            pdfUrl: pdfUrl,
                            formattedId: formattedId
                        }
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: "L·ªói x·ª≠ l√Ω XML: " + error.message
                    };
                }
            },
            
            // H√†m ƒë·ªãnh d·∫°ng ID h√≥a ƒë∆°n
            formatInvoiceIdForLink: function(rawId, sellerMST) {
                if (!rawId) return '';
                
                console.log('Raw ID:', rawId);
                console.log('ID Length:', rawId.length);
                console.log('Seller MST:', sellerMST);
                
                // Ph√¢n t√≠ch ID theo c·∫•u tr√∫c th·ª±c t·∫ø
                // MST (10 k√Ω t·ª±) + NƒÉm (4 k√Ω t·ª±) + S·ªë h√≥a ƒë∆°n (12 k√Ω t·ª±)
                let mst, year, invoiceNumber;
                
                if (rawId.length === 24) {
                    // ƒê·ªãnh d·∫°ng chu·∫©n: 031623981320200300000018
                    mst = rawId.substring(0, 10); // 0316239813
                    year = rawId.substring(10, 14); // 2020
                    invoiceNumber = rawId.substring(14); // 0300000018
                } else if (rawId.length === 26) {
                    // ƒê·ªãnh d·∫°ng kh√°c: 03162398132020030000001800
                    mst = rawId.substring(0, 10); // 0316239813
                    year = rawId.substring(10, 14); // 2020
                    invoiceNumber = rawId.substring(14, 24); // 0300000018
                } else {
                    // ƒê·ªãnh d·∫°ng kh√¥ng x√°c ƒë·ªãnh, s·ª≠ d·ª•ng sellerMST n·∫øu c√≥
                    mst = sellerMST || '0000000000';
                    year = '2020';
                    invoiceNumber = rawId;
                }
                
                // ƒê·∫£m b·∫£o MST c√≥ 10 k√Ω t·ª±
                if (mst.length < 10) {
                    mst = mst.padStart(10, '0');
                }
                
                // ƒê·∫£m b·∫£o invoiceNumber c√≥ 10 k√Ω t·ª±
                if (invoiceNumber.length < 10) {
                    invoiceNumber = invoiceNumber.padStart(10, '0');
                }
                
                const formatted = `ct_${mst}${year}_${invoiceNumber}`;
                console.log('Formatted ID:', formatted);
                
                return formatted;
            }
        };

        // H√†m x·ª≠ l√Ω MISA - MSTTCGP 0101243150
        const MISA_FUNCTION = {
            mst: "0101243150",
            name: "C√¥ng ty C·ªï ph·∫ßn MISA (meInvoice)",
            shortName: "MISA",
            apiBaseUrl: "https://meinvoice.vn",
            pdfGeneratorUrl: "https://meinvoice.vn/tra-cuu/DownloadHandler.ashx",
            lookupUrl: "https://meinvoice.vn/tra-cuu/",
            functionName: "MISA PDF Function",
            
            // H√†m t·∫°o URL cho MISA
            generateUrl: function(sellerTaxCode, transactionId) {
                return `${this.pdfGeneratorUrl}?Type=pdf&MST=${sellerTaxCode}&Code=${transactionId}&Module=${this.mst}`;
            },
            
            // H√†m x·ª≠ l√Ω XML cho MISA
            processXml: function(xmlContent) {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                    
                    // Check for XML parsing errors
                    if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                        return {
                            success: false,
                            error: "XML kh√¥ng h·ª£p l·ªá"
                        };
                    }
                    
                    // Extract required data
                    const sellerTaxCode = xmlDoc.querySelector('NBan > MST')?.textContent;
                    const transactionId = xmlDoc.querySelector('DLHDon')?.getAttribute('Id');
                    
                    if (!sellerTaxCode || !transactionId) {
                        return {
                            success: false,
                            error: "Kh√¥ng t√¨m th·∫•y th√¥ng tin c·∫ßn thi·∫øt trong XML"
                        };
                    }
                    
                    return {
                        success: true,
                        data: {
                            sellerTaxCode: sellerTaxCode,
                            transactionId: transactionId,
                            pdfUrl: this.generateUrl(sellerTaxCode, transactionId)
                        }
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: "L·ªói x·ª≠ l√Ω XML: " + error.message
                    };
                }
            }
        };

        // H√†m x·ª≠ l√Ω BKAV - MSTTCGP 0101360697
        const BKAV_FUNCTION = {
            id: "0101360697",
            name: "C√¥ng ty C·ªï ph·∫ßn BKAV (Bkav eHoadon)",
            shortName: "BKAV",
            baseURL: "https://van.ehoadon.vn/DownloadFile?FilePath=",
            functionName: "BKAV PDF Function",
            
            // X√°c th·ª±c MSTTCGP trong XML
            authenticate: function(xmlContent) {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                    
                    // Ki·ªÉm tra l·ªói XML
                    const parseError = xmlDoc.getElementsByTagName("parsererror");
                    if (parseError.length > 0) {
                        return {
                            success: false,
                            error: "XML kh√¥ng h·ª£p l·ªá: " + parseError[0].textContent
                        };
                    }
                    
                    // T√¨m MSTTCGP trong XML
                    const msttcgpElements = xmlDoc.getElementsByTagName("MSTTCGP");
                    let foundMSTTCGP = null;
                    
                    for (let i = 0; i < msttcgpElements.length; i++) {
                        const mstValue = msttcgpElements[i].textContent.trim();
                        if (mstValue) {
                            foundMSTTCGP = mstValue;
                            break;
                        }
                    }
                    
                    if (!foundMSTTCGP) {
                        return {
                            success: false,
                            error: "Kh√¥ng t√¨m th·∫•y MSTTCGP trong file XML"
                        };
                    }
                    
                    // Ki·ªÉm tra tr√πng kh·ªõp v·ªõi function
                    if (foundMSTTCGP === this.id) {
                        return {
                            success: true,
                            message: "‚úÖ X√°c th·ª±c th√†nh c√¥ng! MSTTCGP tr√πng kh·ªõp v·ªõi function.",
                            msttcgp: foundMSTTCGP
                        };
                    } else {
                        return {
                            success: false,
                            error: `‚ùå MSTTCGP kh√¥ng tr√πng kh·ªõp! Function: ${this.id}, XML: ${foundMSTTCGP}`
                        };
                    }
                    
                } catch (error) {
                    return {
                        success: false,
                        error: "L·ªói ph√¢n t√≠ch XML: " + error.message
                    };
                }
            },
            
            // Ph√¢n t√≠ch XML v√† tr√≠ch xu·∫•t th√¥ng tin
            parseXML: function(xmlContent) {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                    
                    // Tr√≠ch xu·∫•t th√¥ng tin t·ª´ XML
                    const khhDon = xmlDoc.getElementsByTagName("KHHDon")[0]?.textContent || "";
                    const shDon = xmlDoc.getElementsByTagName("SHDon")[0]?.textContent || "";
                    // S·ª¨A ƒê·ªîI: L·∫•y textContent thay v√¨ thu·ªôc t√≠nh Id c·ªßa MCCQT
                    const mcCQT = xmlDoc.getElementsByTagName("MCCQT")[0]?.textContent || "";
                    const msttcgp = xmlDoc.getElementsByTagName("MSTTCGP")[0]?.textContent || "";
                    const nBan = xmlDoc.getElementsByTagName("NBan")[0];
                    const sellerName = nBan?.getElementsByTagName("Ten")[0]?.textContent || "";
                    const sellerMST = nBan?.getElementsByTagName("MST")[0]?.textContent || "";
                    
                    return {
                        success: true,
                        data: {
                            kyyHieu: khhDon,
                            soHoaDon: shDon,
                            maTraCuu: mcCQT,
                            msttcgp: msttcgp,
                            sellerName: sellerName,
                            sellerMST: sellerMST
                        }
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: "L·ªói ph√¢n t√≠ch XML: " + error.message
                    };
                }
            },
            
            // T·∫°o ƒë∆∞·ªùng d·∫´n file PDF
            generateFilePath: function(data) {
                if (!data.kyyHieu || !data.soHoaDon || !data.maTraCuu) {
                    return null;
                }
                
                // T·∫°o th∆∞ m·ª•c con t·ª´ k√Ω hi·ªáu (v√≠ d·ª•: C25TAA -> C2/5T/)
                const folderPath = data.kyyHieu.substring(0, 2) + "/" + 
                                 data.kyyHieu.substring(2, 4) + "/";
                
                // T·∫°o t√™n file
                const fileName = `${data.kyyHieu}-${data.soHoaDon}-${data.maTraCuu}-DPH.pdf`;
                
                return folderPath + fileName;
            },
            
            // T·∫°o link download ho√†n ch·ªânh
            createDownloadLink: function(filePath) {
                if (!filePath) return null;
                return this.baseURL + encodeURIComponent(filePath) + "&BFType=1";
            },
            
            // T·∫°o link t·ª´ XML content
            generateFromXML: function(xmlContent) {
                // X√°c th·ª±c tr∆∞·ªõc
                const authResult = this.authenticate(xmlContent);
                if (!authResult.success) {
                    return authResult;
                }
                
                const parseResult = this.parseXML(xmlContent);
                if (!parseResult.success) {
                    return parseResult;
                }
                
                const filePath = this.generateFilePath(parseResult.data);
                if (!filePath) {
                    return {
                        success: false,
                        error: "Kh√¥ng th·ªÉ t·∫°o ƒë∆∞·ªùng d·∫´n file t·ª´ d·ªØ li·ªáu XML"
                    };
                }
                
                const downloadLink = this.createDownloadLink(filePath);
                
                return {
                    success: true,
                    data: {
                        ...parseResult.data,
                        filePath: filePath,
                        downloadLink: downloadLink
                    }
                };
            }
        };

        // Module EasyInvoice - MSTTCGP 0105987432
        const EASYINVOICE_MODULE = {
            mst: "0105987432",
            name: "C√¥ng ty C·ªï ph·∫ßn ƒê·∫ßu t∆∞ c√¥ng ngh·ªá v√† th∆∞∆°ng m·∫°i Softdreams (EasyInvoice)",
            shortName: "EasyInvoice",
            moduleName: "EasyInvoice Generator"
        };

        // H√†m t·∫°o link EasyInvoice (kh√¥ng ph·∫£i module)
        function createEasyInvoiceLookupURL(jsonData) {
            try {
                // S·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ JSON thay v√¨ XML
                const xmlContent = jsonData.xmlContent;
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                
                // Check for XML parsing errors
                if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                    throw new Error('XML kh√¥ng h·ª£p l·ªá');
                }
                
                // Extract seller tax code
                const sellerTaxCode = xmlDoc.querySelector('NBan MST')?.textContent || '';
                
                // Extract lookup info from TTKhac
                let portalLink = '';
                let fkey = '';
                
                const infoNodes = xmlDoc.querySelectorAll('TTKhac TTin');
                infoNodes.forEach(node => {
                    const field = node.querySelector('TTruong')?.textContent;
                    const value = node.querySelector('DLieu')?.textContent;
                    
                    if (field === 'PortalLink') portalLink = value || '';
                    if (field === 'Fkey') fkey = value || '';
                });
                
                // If no portal link found, generate from tax code
                if (!portalLink && sellerTaxCode) {
                    portalLink = `https://${sellerTaxCode}hd.easyinvoice.com.vn`;
                }
                
                // Validate required data
                if (!portalLink || !fkey) {
                    throw new Error('Thi·∫øu th√¥ng tin tra c·ª©u');
                }
                
                // Extract optional invoice info for better UX
                const invoicePattern = xmlDoc.querySelector('TTChung KHHDon')?.textContent || '';
                const invoiceNo = xmlDoc.querySelector('TTChung SHDon')?.textContent || '';
                
                // Construct URL
                const baseUrl = portalLink.replace(/\/+$/, '');
                let lookupUrl = `${baseUrl}/Search/Index?fkey=${encodeURIComponent(fkey)}`;
                
                // Add optional parameters
                if (invoicePattern) lookupUrl += `&symbol=${encodeURIComponent(invoicePattern)}`;
                if (invoiceNo) lookupUrl += `&invoiceNo=${encodeURIComponent(invoiceNo)}`;
                
                return {
                    success: true,
                    lookupUrl: lookupUrl,
                    portalLink: portalLink,
                    fkey: fkey,
                    sellerTaxCode: sellerTaxCode,
                    invoicePattern: invoicePattern,
                    invoiceNo: invoiceNo
                };
                
            } catch (error) {
                console.error('L·ªói t·∫°o link tra c·ª©u:', error.message);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Danh s√°ch nh√† cung c·∫•p d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠
        const serviceProviders = [
            { mst: "0101243150", name: "C√¥ng ty C·ªï ph·∫ßn MISA (meInvoice)", url: "https://www.meinvoice.vn/tra-cuu/" },
            { mst: "0314743623", name: "C√¥ng ty TNHH C√¥ng ngh·ªá Vƒ©nh Hy", url: "https://ehoadondientu.com/Tra-cuu" },
            { mst: "0101360697", name: "C√¥ng ty C·ªï ph·∫ßn BKAV (Bkav eHoadon)", url: "https://tchd.ehoadon.vn/TCHD?" },
            { mst: "0104128565", name: "C√¥ng ty TNHH H·ªá th·ªëng th√¥ng tin FPT (FPT eInvoice)", url: "https://tracuuhoadon.fpt.com.vn/" },
            { mst: "0102519041", name: "C√¥ng ty C·ªï ph·∫ßn C√¥ng ngh·ªá tin h·ªçc EFY Vi·ªát Nam (iHOADON)", url: "https://ihoadon.vn/kiem-tra/" },
            { mst: "0105987432", name: "C√¥ng ty C·ªï ph·∫ßn ƒê·∫ßu t∆∞ c√¥ng ngh·ªá v√† th∆∞∆°ng m·∫°i Softdreams (EasyInvoice)", url: "http://tracuu.easyinvoice.vn/" },
            { mst: "0302999571", name: "C√¥ng ty TNHH L.C.S (LCS eInvoice)", url: "https://einvoice.lcs.com.vn" },
            { mst: "0313963672", name: "C√¥ng ty TNHH Soft Ware KK VAT", url: "https://hoadon.kkvat.com.vn/ehoadon/ViewIssueBill.jsp" },
            { mst: "0105232093", name: "C√¥ng ty C·ªï ph·∫ßn CyberLotus", url: "https://tracuu.cyberbill.vn/" },
            { mst: "0311942758", name: "C√¥ng ty TNHH Th∆∞∆°ng M·∫°i Ng√¥ Gia Ph√°t", url: "http://tracuu.ngogiaphat.vn" },
            { mst: "0302712571", name: "C√¥ng ty C·ªï ph·∫ßn M·∫Øt B√£o (Mifi)", url: "https://mifi.vn/tra-cuu-hoa-don/" },
            { mst: "0103930279", name: "C√¥ng ty C·ªï ph·∫ßn c√¥ng ngh·ªá th·∫ª Nacencomm", url: "https://hddt.nacencomm.vn/" },
            { mst: "0105844836", name: "C√¥ng ty TNHH C√¥ng ngh·ªá LCD Vi·ªát Nam (AZinvoice)", url: "https://azinvoice.com" },
            { mst: "0106026495", name: "C√¥ng ty TNHH H√≥a ƒë∆°n ƒëi·ªán t·ª≠ M-INVOICE", url: "https://tracuuhoadon.minvoice.com.vn/" },
            { mst: "0313906508", name: "C√¥ng ty C·ªï ph·∫ßn Ph√°t tri·ªÉn c√¥ng ngh·ªá Nguy·ªÖn Minh", url: "http://tracuu.nguyenminhvat.vn/" },
            { mst: "0101300842", name: "C√¥ng ty TNHH Ph√°t tri·ªÉn c√¥ng ngh·ªá Th√°i S∆°n (E-invoice)", url: "https://einvoice.vn/tra-cuu-hoa-don/" },
            { mst: "0306784030", name: "C√¥ng ty TNHH M√°y t√≠nh v√† truy·ªÅn th√¥ng c√¥ng ngh·ªá k·∫øt n·ªëi (eHoaDon Online)", url: "https://ehoadon.online/einvoice/lookup" },
            { mst: "0200638946", name: "C√¥ng ty C·ªï ph·∫ßn c√¥ng ngh·ªá s·ªë v√† in ƒë·ªì h·ªça (Oinvoice)", url: "https://oinvoice.vn/tra-cuu" },
            { mst: "0312303803", name: "C√¥ng ty TNHH Win Tech Solution (WININVOICE)", url: "http://tracuu.wininvoice.vn/" },
            { mst: "0100109106", name: "T·∫≠p ƒëo√†n C√¥ng nghi·ªáp ‚Äì Vi·ªÖn th√¥ng qu√¢n ƒë·ªôi (Viettel/S-Invoice)", url: "https://vinvoice.viettel.vn/utilities/invoice-search" },
            { mst: "0102454468", name: "C√¥ng ty C·ªï ph·∫ßn C√¥ng ngh·ªá th√¥ng tin ƒê√¥ng Nam √Å (Tax24)", url: "https://hoadondientu.tax24.com.vn/Tracuu.aspx" },
            { mst: "0105937449", name: "C√¥ng ty C·ªï ph·∫ßn h√≥a ƒë∆°n ƒëi·ªán t·ª≠ New-Invoice", url: "https://newinvoice.com.vn/tra-cuu/" },
            { mst: "0108516079", name: "C√¥ng ty C·ªï ph·∫ßn Gi·∫£i ph√°p ph·∫ßn m·ªÅm 3A", url: "http://tracuu.3asoft.vn/" },
            { mst: "0100686209", name: "T·ªïng c√¥ng ty Vi·ªÖn th√¥ng Mobifone (Mobifone Invoice)", url: "https://tracuu.mobifoneinvoice.vn/" },
            { mst: "0100684378", name: "T·∫≠p ƒêo√†n B∆∞u ch√≠nh vi·ªÖn th√¥ng Vi·ªát Nam (VNPT-Invoice)", url: "https://portaltool-miennam.vnpt-invoice.com.vn/" },
            { mst: "0401486901", name: "C√¥ng ty C·ªï ph·∫ßn th∆∞∆°ng m·∫°i Visnam (VIN-HOADON)", url: "https://tracuu.vin-hoadon.com/" },
            { mst: "0200784873", name: "C√¥ng ty C·ªï ph·∫ßn Thi·∫øt b·ªã ƒëi·ªán ‚Äì ƒêi·ªán t·ª≠ B√°ch Khoa", url: "https://hoadonbachkhoa.pmbk.vn/tra-cuu-hoa-don" },
            { mst: "0106713804", name: "C√¥ng ty C·ªï ph·∫ßn d·ªãch v·ª• T-VAN HILO", url: "https://tracuuhddt78.hilo.com.vn/" },
            { mst: "0314209362", name: "C√¥ng ty C·ªï ph·∫ßn Minh Khang Group", url: "https://hoadondientuvat.com/Tracuu.aspx" },
            { mst: "0101352495", name: "C√¥ng ty C·ªï ph·∫ßn Gi·∫£i ph√°p h√≥a ƒë∆°n ƒëi·ªán t·ª≠ Vi·ªát Nam (VN-Invoice)", url: "http://tracuu.vninvoice.vn/" },
            { mst: "0102182292", name: "C√¥ng ty C·ªï ph·∫ßn gi·∫£i ph√°p thanh to√°n Vi·ªát Nam", url: "https://www.vnpay.vn" },
            { mst: "0106870211", name: "C√¥ng ty C·ªï ph·∫ßn ICORP (Viet-invoice)", url: "https://viet-invoice.vn/TraCuu/" },
            { mst: "0104614692", name: "C√¥ng ty C·ªï ph·∫ßn ƒë·∫ßu t∆∞ v√† c√¥ng ngh·ªá idocNet (Qinvoice)", url: "https://hoadontvan.com/TraCuu" },
            { mst: "0309612872", name: "C√¥ng ty C·ªï ph·∫ßn ch·ªØ k√Ω s·ªë VI NA", url: "www.smartsign.com.vn" },
            { mst: "0309478306", name: "C√¥ng ty C·ªï ph·∫ßn TS24", url: "http://www.hoadondientu.ts24.com.vn/Tracuuhoadon/" },
            { mst: "0315298333", name: "C√¥ng ty TNHH H√≥a ƒë∆°n ƒëi·ªán t·ª≠ TCT (TCTINVOICE)", url: "http://tracuu.tctinvoice.vn/" },
            { mst: "0303609305", name: "C√¥ng ty TNHH Tin h·ªçc Tia l·ª≠a Vi·ªát (ihoadondientu)", url: "http://tracuu.ihoadondientu.com/" },
            { mst: "0100727825", name: "C√¥ng ty C·ªï ph·∫ßn ph·∫ßn m·ªÅm qu·∫£n l√Ω doanh nghi·ªáp (Fast)", url: "https://invoice.fast.com.vn/" },
            { mst: "0315467091", name: "C√¥ng ty TNHH ACCONLINE.VN", url: "https://acconline.vn/vn/tra-cuu-hoa-don.htm" },
            { mst: "0315638251", name: "C√¥ng ty C·ªï ph·∫ßn c√¥ng ngh·ªá h√≥a ƒë∆°n ƒëi·ªán t·ª≠ HT", url: "https://tracuu.htinvoice.vn/" },
            { mst: "0105958921", name: "C√¥ng ty C·ªï ph·∫ßn c√¥ng ngh·ªá ITT (CloudInvoice)", url: "http://tracuu.cloudinvoice.vn/" },
            { mst: "0302431595", name: "C√¥ng ty TNHH PA Vi·ªát Nam (H√≥a ƒë∆°n 30S)", url: "https://tracuu.hoadon30s.vn/" },
            { mst: "0103018807", name: "C√¥ng ty C·ªï ph·∫ßn t√≠ch h·ª£p c√¥ng ngh·ªá VNISC", url: "https://hoadondientu.vninvoice.vn" },
            { mst: "0106820789", name: "C√¥ng ty TNHH Gi·∫£i ph√°p h√≥a ƒë∆°n ƒëi·ªán t·ª≠ My ‚Äì Invoice", url: "http://tracuu.my-invoice.vn/" },
            { mst: "0310151055", name: "C√¥ng ty C·ªï ph·∫ßn Ch·ª©ng s·ªë An to√†n (SAFE-Invoice)", url: "http://tracuuhoadon.safe-invoice.vn/" },
            { mst: "0303430876", name: "C√¥ng ty C·ªï ph·∫ßn c√¥ng ngh·ªá San Ph√∫", url: "www.spc-technology.com" },
            { mst: "0301452923", name: "C√¥ng ty TNHH Gi·∫•y vi t√≠nh Li√™n S∆°n", url: "https://hoadondientu.lienson.vn/tracuuhoadon.aspx" },
            { mst: "0314185087", name: "C√¥ng ty TNHH Th∆∞∆°ng M·∫°i d·ªãch v·ª• Online VI NA", url: "https://checkinvoice.onlinevina.com.vn/" },
            { mst: "0400462489", name: "C√¥ng ty TNHH Tu·∫ßn Ch√¢u", url: "http://e-invoicetuanchau.com/Invoice/Search" },
            { mst: "03500456910", name: "C√¥ng ty TNHH Minh Th∆∞", url: "https://hoadonminhthuvungtau.com" },
            { mst: "0104908371", name: "C√¥ng ty C·ªï ph·∫ßn ph√°t tri·ªÉn c√¥ng ngh·ªá ACMAN", url: "https://www.acman.vn/hoa-don-dien-tu.html" },
            { mst: "0315191291", name: "C√¥ng ty TNHH T∆∞ v·∫•n th∆∞∆°ng m·∫°i Tr√≠ Vi·ªát Lu·∫≠t", url: "https://hoadonsovn.net" },
            { mst: "0313844107", name: "C√¥ng ty TNHH ƒê·∫ßu t∆∞ H√≤n Ng·ªçc Vi·ªát", url: "http://voice.hoadondientu.net.vn" },
            { mst: "0311622035", name: "C√¥ng ty TNHH D·ªãch v·ª• Tr√≠ Vi·ªát Lu·∫≠t", url: "http://congtyinhoadon.com" },
            { mst: "0106361479", name: "C√¥ng ty C·ªï ph·∫ßn truy·ªÅn s·ªë li·ªáu Vi·ªát Nam (aHoadon)", url: "https://tracuu.ahoadon.com/" },
            { mst: "0312270160", name: "C√¥ng ty TNHH NC9 Vi·ªát Nam", url: "http://ameinvoice.com.vn" },
            { mst: "0104493085", name: "C√¥ng ty C·ªï ph·∫ßn gi·∫£i ph√°p First Trust", url: "https://www.fts.com.vn/phan-mem-hoa-don-dien-tu/" },
            { mst: "0101289966", name: "C√¥ng ty TNHH Ph·∫ßn m·ªÅm Nh√¢n H√≤a", url: "https://hoadon.biz" },
            { mst: "0303211948", name: "C√¥ng ty TNHH K·∫ø to√°n v√† t∆∞ v·∫•n V.L.C", url: "https://ketoanvlc.com" },
            { mst: "0101622374", name: "C√¥ng ty C·ªï ph·∫ßn C√¥ng ngh·ªá v√† gi·∫£i ph√°p T√¢m Vi·ªát", url: "http://tamvietgroup.vn" },
            { mst: "0310768095", name: "C√¥ng ty TNHH D·ªãch v·ª• ph·∫ßn m·ªÅm AVSE", url: "http://hoadondientu.link" },
            { mst: "0312961577", name: "C√¥ng ty TNHH MTV in B·∫øn Th√†nh", url: "http://tracuuhoadon.benthanhvoice.vn" },
            { mst: "0313950909", name: "C√¥ng ty TNHH ZAMO (Koffi)", url: "https://koffi.vn/outbound/lookup-invoice" },
            { mst: "0311928954", name: "C√¥ng ty C·ªï ph·∫ßn c√¥ng ngh·ªá VIETINFO", url: "https://tracuu.vietinfo.tech/" },
            { mst: "0103770970", name: "C√¥ng ty C·ªï ph·∫ßn ph√°t tri·ªÉn ph·∫ßn m·ªÅm v√† c√¥ng ngh·ªá Bitware", url: "https://www.bitware.vn/hoadondientu" },
            { mst: "0305142231", name: "C√¥ng ty C·ªï ph·∫ßn ph·∫ßn m·ªÅm Rosy", url: "https://einv.rosysoft.vn:8386/RSeInvoiceSearch" },
            { mst: "03702037020", name: "C√¥ng ty TNHH MTV th∆∞∆°ng m·∫°i d·ªãch v·ª• Tr·∫ßn ƒê√¨nh T√πng", url: "https://trandinhtung.evat.vn" },
            { mst: "0101925883", name: "C√¥ng ty TNHH T·ªïng c√¥ng ty C√¥ng ngh·ªá v√† Gi·∫£i ph√°p CMC (CMC TS)", url: "http://tracuu.cmcsoft.com/" },
            { mst: "0316642395", name: "C√¥ng ty TNHH C√¥ng ngh·ªá v√† t∆∞ v·∫•n Ph∆∞∆°ng Nam", url: "https://phuongnam.evat.vn/log" },
            { mst: "0315194912", name: "C√¥ng ty TNHH D·ªãch v·ª• k·∫ø to√°n ‚Äì T∆∞ v·∫•n thu·∫ø TTL", url: "https://ttltax.com" },
            { mst: "0315983667", name: "C√¥ng ty C√¥ ph·∫ßn C√¥ng ngh·ªá Ph√°t tri·ªÉn h√≥a ƒë∆°n ƒëi·ªán t·ª≠ Vi·ªát Nam", url: "http://hoadondientuvietnam.vn" },
            { mst: "0310926922", name: "C√¥ng ty TNHH Ph·∫ßn m·ªÅm k·∫ø to√°n v√† d·ªãch v·ª• th·ªß t·ª•c thu·∫ø S√†i G√≤n", url: "https://invoice.ehcm.vn" },
            { mst: "0101010702", name: "C√¥ng ty C·ªï ph·∫ßn Ph·∫ßn m·ªÅm ThƒÉng Long", url: "http://thanglongsoft.com/" },
            { mst: "0102720409", name: "C√¥ng ty C·ªï ph·∫ßn H√≥a ƒë∆°n ƒëi·ªán t·ª≠ TIG ThƒÉng Long", url: "http://trahoadon.tigtax.vn/" },
            { mst: "0314058603", name: "C√¥ng ty TNHH Vi·ªÖn th√¥ng ƒê√¥ng S√†i G√≤n", url: "https://tracuu.vdsg-invoice.vn/" },
            { mst: "0301448733", name: "C√¥ng ty C·ªï ph·∫ßn Tin h·ªçc L·∫°c Vi·ªát", url: "http://tracuu.accnet.vn/" },
            { mst: "0313253288", name: "C√¥ng ty C·ªï ph·∫ßn C√¥ng ngh·ªá TADU", url: "https://autoinvoice.vn" },
            { mst: "0309889835", name: "C√¥ng ty C·ªï ph·∫ßn C√¥ng ngh·ªá UNIT", url: "https://unit.com.vn/" },
            { mst: "0202029650", name: "C√¥ng ty C·ªï ph·∫ßn ph√°t tri·ªÉn v√† ·ª©ng d·ª•ng ph·∫ßn m·ªÅm B√°ch Khoa", url: "https://hoadondientu.pmbk.vn" },
            { mst: "0108971656", name: "C√¥ng ty C·ªï ph·∫ßn My Software", url: "https://tracuu.myinvoice.com.vn/" },
            { mst: "0312942260", name: "C√¥ng ty TNHH C√¥ng ngh·ªá HT S√†i G√≤n", url: "http://tracuu.ihoadondientu.net/" },
            { mst: "01201496252", name: "C√¥ng ty C·ªï ph·∫ßn WEBCASH Vi·ªát Nam", url: "https://einvoice.webcashvietnam.com/" },
            { mst: "0303549303", name: "C√¥ng ty TNHH Ph·∫ßn m·ªÅm v√† T∆∞ v·∫•n Kim T·ª± Th√°p", url: "https://e-invoices.vn/" },
            { mst: "0311914694", name: "C√¥ng ty TNHH Ph·∫ßn m·ªÅm BRB", url: "http://brightbrain.vn/hoa-don-dien-tu/" },
            { mst: "0312617990", name: "C√¥ng ty TNHH Nh√≥m M√¢y", url: "https://www.cloudteam.vn" },
            { mst: "0109282176", name: "C√¥ng ty C·ªï ph·∫ßn H√≥a ƒë∆°n ƒëi·ªán t·ª≠ VININVOICE", url: "https://vininvoice.vn/TraCuu" },
            { mst: "0102723181", name: "Trung t√¢m Tin h·ªçc v√† C√¥ng ngh·ªá s·ªë", url: "http://hoadonct.gov.vn" },
            { mst: "0106858609", name: "C√¥ng ty C·ªï ph·∫ßn VETC", url: "https://vetc.com.vn" },
            { mst: "0315151651", name: "C√¥ng ty TNHH Ph·∫ßn m·ªÅm PVS", url: "https://pvssolution.com/" },
            { mst: "0310151739", name: "C√¥ng ty C·ªï ph·∫ßn D·ªãch v·ª• Th∆∞∆°ng m·∫°i Vi·ªát Nam tr·ª±c tuy·∫øn", url: "https://news.yoinvoice.vn" },
            { mst: "0312575123", name: "C√¥ng ty TNHH Ecount Vi·ªát Nam", url: "https://ecount.com" },
            { mst: "0107732197", name: "C√¥ng ty C·ªï ph·∫ßn ATIS", url: "https://tracuu.atis.com.vn/" },
            { mst: "0101659906", name: "C√¥ng ty C·ªï ph·∫ßn GMO-Z.com RUNSYSTEM (KAIKE)", url: "https://einvoice.kaike.vn/tracuu" },
            { mst: "0103019524", name: "C√¥ng ty C·ªï ph·∫ßn Tin h·ªçc ‚Äì Vi·ªÖn th√¥ng H√†ng kh√¥ng (AITS)", url: "https://tracuu.aits.vn/" },
            { mst: "0316114998", name: "C√¥ng ty TNHH Bizzi VietNam", url: "https://bizzi.vn/" },
            { mst: "0316636497", name: "C√¥ng ty C·ªï ph·∫ßn C√¥ng ngh·ªá BEE (Bee Logistics)", url: "https://e-invoice.beelogistics.com/" },
            { mst: "0106249501", name: "C√¥ng ty C·ªï ph·∫ßn MONT-E", url: "http://tracuuhoadon.mont-e.com/" },
            { mst: "0201802839", name: "C√¥ng ty TNHH T∆∞ v·∫•n v√† D·ªãch v·ª• Home Casta", url: "https://homecasta.vn" },
            { mst: "04601328480", name: "C√¥ng ty CP T∆∞ v·∫•n v√† Chuy·ªÉn giao c√¥ng ngh·ªá S∆°n Ph√°t", url: "https://sonphat.vn" }
        ];

        // Danh s√°ch nh√† cung c·∫•p h·ªó tr·ª£ t·∫£i PDF tr·ª±c ti·∫øp
        const directPdfDownloadProviders = [
            {
                mst: "0101243150",
                name: "C√¥ng ty C·ªï ph·∫ßn MISA (meInvoice)",
                pdfUrlPattern: "https://meinvoice.vn/tra-cuu/DownloadHandler.ashx?Type=pdf&MST={sellerTaxCode}&Code={transactionId}&Module={moduleCode}",
                description: "H·ªó tr·ª£ t·∫£i PDF tr·ª±c ti·∫øp t·ª´ MISA",
                requiresVerificationCode: false,
                autoFillSupported: true
            },
            {
                mst: "0100684378", 
                name: "T·∫≠p ƒêo√†n B∆∞u ch√≠nh vi·ªÖn th√¥ng Vi·ªát Nam (VNPT-Invoice)",
                pdfUrlPattern: "https://portaltool-miennam.vnpt-invoice.com.vn/api/invoice/download?code={code}",
                description: "H·ªó tr·ª£ t·∫£i PDF tr·ª±c ti·∫øp t·ª´ VNPT",
                requiresVerificationCode: true,
                autoFillSupported: false
            },
            {
                mst: "0100109106",
                name: "T·∫≠p ƒëo√†n C√¥ng nghi·ªáp ‚Äì Vi·ªÖn th√¥ng qu√¢n ƒë·ªôi (Viettel/S-Invoice)",
                pdfUrlPattern: "https://vinvoice.viettel.vn/api/invoice/download/{code}",
                description: "H·ªó tr·ª£ t·∫£i PDF tr·ª±c ti·∫øp t·ª´ Viettel",
                requiresVerificationCode: true,
                autoFillSupported: false
            },
            {
                mst: "0101360697",
                name: "C√¥ng ty C·ªï ph·∫ßn BKAV (Bkav eHoadon)",
                pdfUrlPattern: "https://van.ehoadon.vn/DownloadFile?FilePath={filePath}&BFType=1",
                description: "H·ªó tr·ª£ t·∫£i PDF tr·ª±c ti·∫øp t·ª´ BKAV",
                requiresVerificationCode: false,
                autoFillSupported: true
            },
            {
                mst: "0314743623",
                name: "C√¥ng ty TNHH C√¥ng ngh·ªá Vƒ©nh Hy",
                pdfUrlPattern: "https://ehoadondientu.com/api/download/{code}",
                description: "H·ªó tr·ª£ t·∫£i PDF tr·ª±c ti·∫øp t·ª´ Vƒ©nh Hy",
                requiresVerificationCode: false,
                autoFillSupported: true
            },
            {
                mst: "0104128565",
                name: "C√¥ng ty TNHH H·ªá th·ªëng th√¥ng tin FPT (FPT eInvoice)",
                pdfUrlPattern: "https://tracuuhoadon.fpt.com.vn/api/download/{code}",
                description: "H·ªó tr·ª£ t·∫£i PDF tr·ª±c ti·∫øp t·ª´ FPT",
                requiresVerificationCode: false,
                autoFillSupported: true
            },
            {
                mst: "0105987432",
                name: "C√¥ng ty C·ªï ph·∫ßn ƒê·∫ßu t∆∞ c√¥ng ngh·ªá v√† th∆∞∆°ng m·∫°i Softdreams (EasyInvoice)",
                pdfUrlPattern: "{portalLink}/Search/Index?fkey={fkey}",
                description: "H·ªó tr·ª£ tra c·ª©u tr·ª±c ti·∫øp t·ª´ EasyInvoice",
                requiresVerificationCode: false,
                autoFillSupported: true
            }
        ];

        // H√†m t·∫°o URL tra c·ª©u ƒë·∫∑c bi·ªát cho c√°c nh√† cung c·∫•p c·ª• th·ªÉ
        function createSpecialLookupUrl(providerMST, transactionID, sellerTaxCode, verificationCode) {
            if (!transactionID) return null;
            
            switch(providerMST) {
                case "0101360697": // BKAV
                    return `https://van.ehoadon.vn/Lookup?InvoiceGUID=${transactionID}`;
                case "0101243150": // MISA
                    return `https://www.meinvoice.vn/tra-cuu/?sc=${transactionID}`;
                case "0100109106": // Viettel
                    let viettelUrl = "https://vinvoice.viettel.vn/utilities/invoice-search";
                    if (sellerTaxCode && verificationCode) {
                        viettelUrl += `?sellerTaxCode=${encodeURIComponent(sellerTaxCode)}&verificationCode=${encodeURIComponent(verificationCode)}`;
                    }
                    return viettelUrl;
                case "0100684378": // VNPT
                    let vnptUrl = "https://portaltool-miennam.vnpt-invoice.com.vn/";
                    if (verificationCode) {
                        vnptUrl += `search?code=${encodeURIComponent(verificationCode)}`;
                    }
                    return vnptUrl;
                case "0314743623": // Vƒ©nh Hy
                    let vinhHyUrl = "https://ehoadondientu.com/Tra-cuu";
                    if (sellerTaxCode && verificationCode) {
                        vinhHyUrl += `?seller=${encodeURIComponent(sellerTaxCode)}&code=${encodeURIComponent(verificationCode)}`;
                    }
                    return vinhHyUrl;
                case "0104128565": // FPT
                    let fptUrl = "https://tracuuhoadon.fpt.com.vn/";
                    if (sellerTaxCode) {
                        fptUrl += `search?taxCode=${encodeURIComponent(sellerTaxCode)}`;
                    }
                    return fptUrl;
                case "0105987432": // EasyInvoice
                    let easyInvoiceUrl = "http://tracuu.easyinvoice.vn/";
                    if (sellerTaxCode) {
                        easyInvoiceUrl = `https://${sellerTaxCode}hd.easyinvoice.com.vn/Search/Index`;
                    }
                    return easyInvoiceUrl;
                default:
                    return null;
            }
        }

        // H√†m t·∫°o URL t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin
        function createAutoFillUrl(providerMST, sellerTaxCode, verificationCode, transactionID) {
            if (!providerMST || !sellerTaxCode) return null;
            
            const provider = serviceProviders.find(p => p.mst === providerMST);
            if (!provider) return null;
            
            let baseUrl = provider.url;
            
            // Th√™m tham s·ªë t·ª± ƒë·ªông ƒëi·ªÅn cho c√°c nh√† cung c·∫•p h·ªó tr·ª£
            const params = new URLSearchParams();
            
            if (sellerTaxCode) {
                params.append('sellerTaxCode', sellerTaxCode);
                params.append('taxCode', sellerTaxCode);
                params.append('mst', sellerTaxCode);
            }
            
            if (verificationCode) {
                params.append('verificationCode', verificationCode);
                params.append('code', verificationCode);
                params.append('fkey', verificationCode);
                params.append('searchCode', verificationCode);
            }
            
            if (transactionID) {
                params.append('transactionId', transactionID);
                params.append('invoiceId', transactionID);
                params.append('guid', transactionID);
            }
            
            const queryString = params.toString();
            return queryString ? `${baseUrl}${baseUrl.includes('?') ? '&' : '?'}${queryString}` : baseUrl;
        }

        // L·∫•y th√¥ng tin nh√† cung c·∫•p d·ªãch v·ª• t·ª´ API
        async function getServiceProviderInfo(taxCode) {
            if (!taxCode) return null;
            
            try {
                const response = await fetch(`https://api.vietqr.io/v2/business/${taxCode}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('L·ªói khi l·∫•y th√¥ng tin nh√† cung c·∫•p d·ªãch v·ª•:', error);
                return null;
            }
        }

        // Kh·ªüi t·∫°o danh s√°ch nh√† cung c·∫•p
        function initializeProviders() {
            const providerSelect = document.getElementById('providerSelect');
            providerSelect.innerHTML = '<option value="">-- Ch·ªçn nh√† cung c·∫•p --</option>';
            
            // N·∫øu c√≥ nh√† cung c·∫•p ph√π h·ª£p, ch·ªâ hi·ªÉn th·ªã nh·ªØng nh√† cung c·∫•p ƒë√≥
            if (matchedProviders.length > 0) {
                matchedProviders.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider.mst;
                    option.textContent = `${provider.name} (MST: ${provider.mst})`;
                    option.setAttribute('data-provider-name', provider.name);
                    option.setAttribute('data-mst', provider.mst);
                    option.setAttribute('data-url', provider.url);
                    providerSelect.appendChild(option);
                });
            } else {
                // N·∫øu kh√¥ng c√≥ nh√† cung c·∫•p ph√π h·ª£p, hi·ªÉn th·ªã t·∫•t c·∫£
                serviceProviders.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider.mst;
                    option.textContent = `${provider.name} (MST: ${provider.mst})`;
                    option.setAttribute('data-provider-name', provider.name);
                    option.setAttribute('data-mst', provider.mst);
                    option.setAttribute('data-url', provider.url);
                    providerSelect.appendChild(option);
                });
            }
        }

        // T√¨m nh√† cung c·∫•p ph√π h·ª£p d·ª±a tr√™n MSTTCGP
        function findMatchingProviders(taxCode) {
            if (!taxCode) return [];
            
            const matched = [];
            
            // T√¨m ki·∫øm ch√≠nh x√°c
            serviceProviders.forEach(provider => {
                if (provider.mst === taxCode) {
                    matched.push(provider);
                }
            });
            
            // N·∫øu kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ch√≠nh x√°c, t√¨m ki·∫øm g·∫ßn ƒë√∫ng
            if (matched.length === 0) {
                serviceProviders.forEach(provider => {
                    if (provider.mst.includes(taxCode) || taxCode.includes(provider.mst)) {
                        matched.push(provider);
                    }
                });
            }
            
            return matched;
        }

        // Ki·ªÉm tra nh√† cung c·∫•p c√≥ h·ªó tr·ª£ t·∫£i PDF tr·ª±c ti·∫øp kh√¥ng
        function checkDirectPdfDownloadSupport(taxCode, verificationCode) {
            if (!taxCode) return null;
            
            // T√¨m nh√† cung c·∫•p trong danh s√°ch h·ªó tr·ª£ t·∫£i PDF
            const provider = directPdfDownloadProviders.find(p => p.mst === taxCode);
            
            if (provider) {
                // T·∫°o URL t·∫£i PDF
                let pdfUrl = provider.pdfUrlPattern;
                
                // Thay th·∫ø c√°c tham s·ªë
                pdfUrl = pdfUrl.replace('{sellerTaxCode}', encodeURIComponent(invoiceData.sellerTaxCode || ''));
                pdfUrl = pdfUrl.replace('{transactionId}', encodeURIComponent(invoiceData.transactionID || ''));
                pdfUrl = pdfUrl.replace('{moduleCode}', encodeURIComponent(provider.mst));
                
                // N·∫øu c·∫ßn m√£ tra c·ª©u v√† c√≥ m√£, thay th·∫ø v√†o URL
                if (provider.requiresVerificationCode && verificationCode) {
                    pdfUrl = pdfUrl.replace('{code}', encodeURIComponent(verificationCode));
                } else if (!provider.requiresVerificationCode) {
                    // N·∫øu kh√¥ng c·∫ßn m√£ tra c·ª©u, c√≥ th·ªÉ s·ª≠ d·ª•ng URL g·ªëc
                    pdfUrl = pdfUrl.replace('{code}', '');
                } else {
                    // N·∫øu c·∫ßn m√£ tra c·ª©u nh∆∞ng kh√¥ng c√≥ m√£, kh√¥ng th·ªÉ t·∫°o URL
                    return {
                        provider: provider,
                        pdfUrl: null,
                        requiresCode: true
                    };
                }
                
                return {
                    provider: provider,
                    pdfUrl: pdfUrl,
                    requiresCode: provider.requiresVerificationCode,
                    autoFillSupported: provider.autoFillSupported
                };
            }
            
            return null;
        }

        // C·∫≠p nh·∫≠t danh s√°ch nh√† cung c·∫•p v·ªõi th√¥ng tin t·ª´ API
        async function updateProvidersWithApiInfo(serviceTaxCode) {
            if (!serviceTaxCode) return;
            
            const providerSelect = document.getElementById('providerSelect');
            const providerLoading = document.getElementById('providerLoading');
            
            // Hi·ªÉn th·ªã loading
            providerLoading.style.display = 'block';
            
            try {
                const providerInfo = await getServiceProviderInfo(serviceTaxCode);
                
                if (providerInfo && providerInfo.data) {
                    serviceProviderInfo = providerInfo.data;
                    
                    // T√¨m v√† c·∫≠p nh·∫≠t option t∆∞∆°ng ·ª©ng trong dropdown
                    const options = providerSelect.getElementsByTagName('option');
                    for (let option of options) {
                        const mst = option.getAttribute('data-mst');
                        if (mst === serviceTaxCode) {
                            // C·∫≠p nh·∫≠t t√™n hi·ªÉn th·ªã v·ªõi th√¥ng tin t·ª´ API
                            const apiName = providerInfo.data.name || option.getAttribute('data-provider-name');
                            option.textContent = `${apiName} (MST: ${serviceTaxCode})`;
                            option.selected = true;
                            break;
                        }
                    }
                    
                    // C·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt nh√† cung c·∫•p
                    updateProviderDetails(providerInfo.data);
                }
            } catch (error) {
                console.error('L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin nh√† cung c·∫•p:', error);
            } finally {
                providerLoading.style.display = 'none';
            }
        }

        // C·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt nh√† cung c·∫•p
        function updateProviderDetails(providerData) {
            const providerDetails = document.getElementById('providerDetails');
            
            if (providerData) {
                providerDetails.innerHTML = `
                    <h4>Th√¥ng tin nh√† cung c·∫•p d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠:</h4>
                    <p><strong>T√™n ƒë∆°n v·ªã:</strong> ${providerData.name || 'Kh√¥ng c√≥ th√¥ng tin'}</p>
                    <p><strong>M√£ s·ªë thu·∫ø:</strong> ${providerData.taxCode || 'Kh√¥ng c√≥ th√¥ng tin'}</p>
                    <p><strong>ƒê·ªãa ch·ªâ:</strong> ${providerData.address || 'Kh√¥ng c√≥ th√¥ng tin'}</p>
                    <p><strong>Ng∆∞·ªùi ƒë·∫°i di·ªán:</strong> ${providerData.representative || 'Kh√¥ng c√≥ th√¥ng tin'}</p>
                    <p><strong>Tr·∫°ng th√°i:</strong> ${providerData.status || 'Kh√¥ng c√≥ th√¥ng tin'}</p>
                `;
                providerDetails.style.display = 'block';
            }
        }

        // Hi·ªÉn th·ªã danh s√°ch nh√† cung c·∫•p trong b·∫£ng
        function displayProviderList() {
            const container = document.getElementById('providerTableContainer');
            
            let tableHTML = `
                <table class="provider-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>MSTTCGP</th>
                            <th>T√™n Nh√† Cung C·∫•p</th>
                            <th>Link Tra C·ª©u</th>
                            <th>H·ªó tr·ª£ PDF</th>
                            <th>T·ª± ƒë·ªông ƒëi·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            serviceProviders.forEach((provider, index) => {
                const supportsPdf = directPdfDownloadProviders.some(p => p.mst === provider.mst);
                const supportsAutoFill = directPdfDownloadProviders.some(p => p.mst === provider.mst && p.autoFillSupported);
                const pdfBadge = supportsPdf ? '<span class="provider-badge">PDF</span>' : '';
                const autoFillBadge = supportsAutoFill ? '<span class="provider-badge">Auto</span>' : '';
                
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${provider.mst}</td>
                        <td>${provider.name} ${pdfBadge} ${autoFillBadge}</td>
                        <td><a href="${provider.url}" target="_blank" class="provider-link">${provider.url}</a></td>
                        <td>${supportsPdf ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</td>
                        <td>${supportsAutoFill ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        // H√†m l∆∞u XML v√†o file JSON - Y√äU C·∫¶U 1
        function saveXmlToJson(xmlContent, fileName) {
            try {
                // T·∫°o ƒë·ªëi t∆∞·ª£ng JSON t·ª´ XML
                const jsonData = {
                    xmlContent: xmlContent,
                    fileName: fileName,
                    timestamp: new Date().toISOString(),
                    processedData: invoiceData
                };
                
                // L∆∞u v√†o localStorage thay v√¨ t·∫£i v·ªÅ file
                localStorage.setItem('invoiceJsonData', JSON.stringify(jsonData));
                
                console.log('ƒê√£ l∆∞u XML v√†o JSON trong localStorage:', fileName);
                return true;
            } catch (error) {
                console.error('L·ªói khi l∆∞u XML v√†o JSON:', error);
                return false;
            }
        }

        // H√†m t·∫£i d·ªØ li·ªáu JSON t·ª´ localStorage
        function loadJsonFromStorage() {
            try {
                const jsonData = localStorage.getItem('invoiceJsonData');
                if (jsonData) {
                    return JSON.parse(jsonData);
                }
                return null;
            } catch (error) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu JSON t·ª´ localStorage:', error);
                return null;
            }
        }

        /**
         * THU·∫¨T TO√ÅN M·ªöI: Tr√≠ch xu·∫•t m√£ tra c·ª©u portal t·ª´ h√≥a ƒë∆°n ƒëi·ªán t·ª≠ Vi·ªát Nam
         * @param {string} xmlContent - N·ªôi dung XML h√≥a ƒë∆°n
         * @returns {Array} - M·∫£ng c√°c m√£ tra c·ª©u t√¨m th·∫•y
         */
        function extractPortalCodes(xmlContent) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
                
                const foundCodes = [];
                const processedCodes = new Set();

                // L·∫•y MSTTCGP ƒë·ªÉ x√°c ƒë·ªãnh ∆∞u ti√™n
                const msttcgpElements = xmlDoc.getElementsByTagName("MSTTCGP");
                let msttcgp = "";
                if (msttcgpElements.length > 0) {
                    msttcgp = msttcgpElements[0].textContent.trim();
                }

                // 1. X·ª¨ L√ù ƒê·∫∂C BI·ªÜT CHO MSTTCGP 0312303803 - Y√äU C·∫¶U 1
                if (msttcgp === "0312303803") {
                    // T√¨m trong TTKhac v·ªõi Id="privateCode"
                    const ttinElements = xmlDoc.getElementsByTagName("TTin");
                    for (let element of ttinElements) {
                        const elementId = element.getAttribute("Id");
                        if (elementId === "privateCode") {
                            const dlieu = element.getElementsByTagName("DLieu")[0];
                            if (dlieu && dlieu.textContent && !processedCodes.has(dlieu.textContent)) {
                                foundCodes.push({
                                    code: dlieu.textContent.trim(),
                                    field: "privateCode",
                                    type: "private_code",
                                    source: "TTKhac",
                                    priority: 1
                                });
                                processedCodes.add(dlieu.textContent);
                                break;
                            }
                        }
                    }
                }
                // 2. X·ª¨ L√ù ƒê·∫∂C BI·ªÜT CHO MSTTCGP 0100109106 (Viettel) - Y√äU C·∫¶U M·ªöI
                else if (msttcgp === "0100109106") {
                    // Viettel: T√¨m trong TTKhac v·ªõi TTruong l√† "M√£ s·ªë b√≠ m·∫≠t"
                    const ttinElements = xmlDoc.getElementsByTagName("TTin");
                    for (let element of ttinElements) {
                        const children = element.children;
                        let fieldName = '';
                        let dataValue = '';
                        
                        for (let child of children) {
                            if (child.tagName === 'TTruong') fieldName = child.textContent || '';
                            if (child.tagName === 'DLieu') dataValue = child.textContent || '';
                        }
                        
                        if (fieldName && fieldName.toLowerCase().includes('m√£ s·ªë b√≠ m·∫≠t') && 
                            dataValue && !processedCodes.has(dataValue)) {
                            foundCodes.push({
                                code: dataValue,
                                field: fieldName,
                                type: "secret_code",
                                source: "TTKhac",
                                priority: 1
                            });
                            processedCodes.add(dataValue);
                            break;
                        }
                    }
                }
                // 3. ∆ØU TI√äN CAO: T√¨m theo MSTTCGP c·ª• th·ªÉ
                else if (msttcgp === "0101243150") {
                    // MISA: ∆Øu ti√™n thu·ªôc t√≠nh ID c·ªßa th·∫ª DLHDon
                    const dlhdonElements = xmlDoc.getElementsByTagName("DLHDon");
                    if (dlhdonElements.length > 0) {
                        const dlhdonId = dlhdonElements[0].getAttribute("Id");
                        if (dlhdonId && dlhdonId.trim() && !processedCodes.has(dlhdonId)) {
                            foundCodes.push({
                                code: dlhdonId.trim(),
                                field: "DLHDon Id",
                                type: "transaction_id",
                                source: "DLHDon",
                                priority: 1
                            });
                            processedCodes.add(dlhdonId);
                        }
                    }
                } else if (msttcgp === "0100684378" || msttcgp === "0105987432") {
                    // VNPT v√† EasyInvoice: ∆Øu ti√™n kh√≥a Fkey
                    const ttinElements = xmlDoc.getElementsByTagName("TTin");
                    for (let element of ttinElements) {
                        const children = element.children;
                        let fieldName = '';
                        let dataValue = '';
                        
                        for (let child of children) {
                            if (child.tagName === 'TTruong') fieldName = child.textContent || '';
                            if (child.tagName === 'DLieu') dataValue = child.textContent || '';
                        }
                        
                        if (fieldName && fieldName.toLowerCase().includes('fkey') && 
                            dataValue && !processedCodes.has(dataValue)) {
                            foundCodes.push({
                                code: dataValue,
                                field: fieldName,
                                type: "fkey",
                                source: "TTKhac",
                                priority: 1
                            });
                            processedCodes.add(dataValue);
                        }
                    }
                } else {
                    // C√°c MSTTCGP c√≤n l·∫°i: ∆Øu ti√™n thu·ªôc t√≠nh ID c·ªßa DLHDon v√† kh√≥a Fkey
                    
                    // ∆Øu ti√™n 1: Thu·ªôc t√≠nh ID c·ªßa DLHDon
                    const dlhdonElements = xmlDoc.getElementsByTagName("DLHDon");
                    if (dlhdonElements.length > 0) {
                        const dlhdonId = dlhdonElements[0].getAttribute("Id");
                        if (dlhdonId && dlhdonId.trim() && !processedCodes.has(dlhdonId)) {
                            foundCodes.push({
                                code: dlhdonId.trim(),
                                field: "DLHDon Id",
                                type: "transaction_id",
                                source: "DLHDon",
                                priority: 1
                            });
                            processedCodes.add(dlhdonId);
                        }
                    }
                    
                    // ∆Øu ti√™n 2: Kh√≥a Fkey
                    const ttinElements = xmlDoc.getElementsByTagName("TTin");
                    for (let element of ttinElements) {
                        const children = element.children;
                        let fieldName = '';
                        let dataValue = '';
                        
                        for (let child of children) {
                            if (child.tagName === 'TTruong') fieldName = child.textContent || '';
                            if (child.tagName === 'DLieu') dataValue = child.textContent || '';
                        }
                        
                        if (fieldName && fieldName.toLowerCase().includes('fkey') && 
                            dataValue && !processedCodes.has(dataValue)) {
                            foundCodes.push({
                                code: dataValue,
                                field: fieldName,
                                type: "fkey",
                                source: "TTKhac",
                                priority: 2
                            });
                            processedCodes.add(dataValue);
                        }
                    }
                }

                // 4. T√¨m trong c√°c tr∆∞·ªùng TTKhac kh√°c (∆∞u ti√™n th·∫•p h∆°n)
                const ttinElements = xmlDoc.getElementsByTagName('TTin');
                for (let element of ttinElements) {
                    const children = element.children;
                    let fieldName = '';
                    let dataValue = '';
                    
                    for (let child of children) {
                        if (child.tagName === 'TTruong') fieldName = child.textContent || '';
                        if (child.tagName === 'DLieu') dataValue = child.textContent || '';
                    }
                    
                    if (dataValue && !processedCodes.has(dataValue) && isPortalCode(dataValue)) {
                        foundCodes.push({
                            code: dataValue,
                            field: fieldName,
                            type: getCodeType(fieldName),
                            source: 'TTKhac',
                            priority: 3
                        });
                        processedCodes.add(dataValue);
                    }
                }

                // 5. T√¨m trong to√†n b·ªô XML (d·ª± ph√≤ng)
                const allText = xmlDoc.documentElement.textContent || '';
                const words = allText.split(/[\s<>]+/).filter(word => word.trim().length > 0);
                
                for (let word of words) {
                    const cleanWord = word.replace(/[^\w*\-_]/g, '');
                    if (isPortalCode(cleanWord) && !processedCodes.has(cleanWord)) {
                        foundCodes.push({
                            code: cleanWord,
                            field: 'auto_detected',
                            type: 'auto_detected',
                            source: 'text_scan',
                            priority: 4
                        });
                        processedCodes.add(cleanWord);
                    }
                }

                // S·∫Øp x·∫øp theo ƒë·ªô ∆∞u ti√™n (priority th·∫•p h∆°n = ∆∞u ti√™n cao h∆°n)
                foundCodes.sort((a, b) => a.priority - b.priority);

                return foundCodes;

            } catch (error) {
                console.error('L·ªói ph√¢n t√≠ch XML:', error);
                return [];
            }
        }

        // Ki·ªÉm tra pattern m√£ tra c·ª©u portal - C·∫¨P NH·∫¨T THEO Y√äU C·∫¶U 1
        function isPortalCode(text) {
            if (!text || typeof text !== 'string') return false;
            if (text.length < 6 || text.length > 25) return false;
            
            // Lo·∫°i b·ªè c√°c m√£ hex d√†i (MCCQT)
            if (/^[0-9A-F]{32,}$/i.test(text)) return false;
            
            // Pattern cho m√£ tra c·ª©u portal - C·∫¨P NH·∫¨T THEO Y√äU C·∫¶U 1
            const patterns = [
                /^[A-Z0-9*]+$/,           // Ch·ªâ ch·ªØ hoa, s·ªë v√† k√Ω t·ª± "*"
                /^[A-Z0-9]{6,25}$/,       // Ch·ªâ ch·ªØ hoa v√† s·ªë
                /^[A-Z0-9*]{6,25}$/       // Ch·ªØ hoa, s·ªë v√† c√≥ th·ªÉ c√≥ "*"
            ];
            
            return patterns.some(pattern => pattern.test(text));
        }

        // H√†m h·ªó tr·ª£ ph√¢n lo·∫°i m√£
        function getCodeType(fieldName) {
            if (!fieldName) return 'unknown';
            
            const field = fieldName.toLowerCase();
            if (field.includes('fkey')) return 'fkey';
            if (field.includes('portal')) return 'portal';
            if (field.includes('secret') || field.includes('b√≠ m·∫≠t')) return 'secret';
            if (field.includes('tra c·ª©u') || field.includes('tracuu')) return 'tra_cuu';
            
            return 'other';
        }

        // Thu·∫≠t to√°n t√¨m ki·∫øm Transaction ID ƒë∆∞·ª£c c·∫£i ti·∫øn
        function findTransactionID(xmlDoc) {
            console.log("üîç B·∫Øt ƒë·∫ßu t√¨m ki·∫øm Transaction ID...");
            
            // ∆ØU TI√äN CAO NH·∫§T: T√¨m trong thu·ªôc t√≠nh Id c·ªßa th·∫ª DLHDon
            const dlhdonElements = xmlDoc.getElementsByTagName('DLHDon');
            if (dlhdonElements.length > 0) {
                const dlhdonId = dlhdonElements[0].getAttribute('Id');
                if (dlhdonId && dlhdonId.trim()) {
                    console.log(`‚úÖ T√¨m th·∫•y Transaction ID trong thu·ªôc t√≠nh Id c·ªßa DLHDon: ${dlhdonId}`);
                    return dlhdonId.trim();
                }
            }
            
            // Pattern cho Transaction ID: chu·ªói ch·ªØ v√† s·ªë, c√≥ th·ªÉ c√≥ d·∫•u g·∫°ch ngang
            const transactionIdPattern = /^[A-Za-z0-9\-_]+$/;
            
            // T√¨m ki·∫øm trong to√†n b·ªô c·∫•u tr√∫c XML
            const allElements = xmlDoc.getElementsByTagName('*');
            const candidates = [];
            
            for (let i = 0; i < allElements.length; i++) {
                const element = allElements[i];
                const textContent = element.textContent.trim();
                
                // Ki·ªÉm tra n·∫øu n·ªôi dung ph√π h·ª£p v·ªõi pattern transaction ID
                if (textContent && transactionIdPattern.test(textContent)) {
                    // Ki·ªÉm tra ƒë·ªô d√†i h·ª£p l√Ω (th∆∞·ªùng t·ª´ 10-50 k√Ω t·ª±)
                    if (textContent.length >= 10 && textContent.length <= 50) {
                        console.log(`‚úÖ T√¨m th·∫•y ·ª©ng vi√™n Transaction ID: ${textContent} (tag: ${element.tagName})`);
                        candidates.push({
                            value: textContent,
                            tagName: element.tagName,
                            parentTag: element.parentNode ? element.parentNode.tagName : 'N/A'
                        });
                    }
                }
            }
            
            // ∆Øu ti√™n c√°c tag c√≥ t√™n li√™n quan ƒë·∫øn transaction ID
            const priorityTags = ['TransactionID', 'InvoiceGUID', 'GUID', 'UUID', 'MaGiaoDich', 'Reference', 'Id', 'ID'];
            
            for (const candidate of candidates) {
                if (priorityTags.includes(candidate.tagName)) {
                    console.log(`üéØ T√¨m th·∫•y Transaction ID trong tag ∆∞u ti√™n '${candidate.tagName}': ${candidate.value}`);
                    return candidate.value;
                }
            }
            
            // T√¨m trong TTKhac v·ªõi thu·∫≠t to√°n c·∫£i ti·∫øn
            const ttKhac = xmlDoc.getElementsByTagName('TTKhac');
            if (ttKhac.length > 0) {
                console.log("üîç ƒêang t√¨m trong TTKhac...");
                const ttinList = ttKhac[0].getElementsByTagName('TTin');
                for (let i = 0; i < ttinList.length; i++) {
                    const ttruong = ttinList[i].getElementsByTagName('TTruong')[0];
                    const dlieu = ttinList[i].getElementsByTagName('DLieu')[0];
                    
                    if (ttruong && dlieu) {
                        const fieldName = ttruong.textContent.toLowerCase();
                        const fieldValue = dlieu.textContent.trim();
                        
                        // Ki·ªÉm tra c√°c t·ª´ kh√≥a li√™n quan ƒë·∫øn transaction ID
                        if (fieldValue && transactionIdPattern.test(fieldValue) && 
                            (fieldName.includes('transaction') ||
                             fieldName.includes('guid') ||
                             fieldName.includes('invoiceid') ||
                             fieldName.includes('invoiceguid') ||
                             fieldName.includes('uuid') ||
                             fieldName.includes('m√£ giao d·ªãch') ||
                             fieldName.includes('m√£ h√≥a ƒë∆°n') ||
                             fieldName.includes('s·ªë bi√™n nh·∫≠n') ||
                             fieldName.includes('reference') ||
                             fieldName.includes('id'))) {
                            console.log(`‚úÖ T√¨m th·∫•y Transaction ID trong TTKhac: ${fieldValue}`);
                            return fieldValue;
                        }
                    }
                }
            }
            
            // N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, tr·∫£ v·ªÅ candidate ƒë·∫ßu ti√™n (n·∫øu c√≥)
            if (candidates.length > 0) {
                console.log(`üîÑ S·ª≠ d·ª•ng candidate ƒë·∫ßu ti√™n: ${candidates[0].value}`);
                return candidates[0].value;
            }
            
            // Fallback: s·ª≠ d·ª•ng s·ªë h√≥a ƒë∆°n n·∫øu kh√¥ng t√¨m th·∫•y transaction ID
            if (invoiceData.invoiceNo) {
                console.log(`üîÑ S·ª≠ d·ª•ng s·ªë h√≥a ƒë∆°n l√†m Transaction ID: ${invoiceData.invoiceNo}`);
                return invoiceData.invoiceNo;
            }
            
            console.log("‚ùå Kh√¥ng t√¨m th·∫•y Transaction ID");
            return '';
        }

        // H√†m x·ª≠ l√Ω XML chung ƒë·ªÉ tr√≠ch xu·∫•t th√¥ng tin
        function processXmlData(xmlContent) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, 'text/xml');
                
                // Ki·ªÉm tra l·ªói XML
                const parseError = xmlDoc.getElementsByTagName('parsererror');
                if (parseError.length > 0) {
                    throw new Error('File XML kh√¥ng h·ª£p l·ªá');
                }
                
                // Tr√≠ch xu·∫•t th√¥ng tin c∆° b·∫£n
                const sellerName = xmlDoc.querySelector('NBan > Ten')?.textContent || '';
                const sellerTaxCode = xmlDoc.querySelector('NBan > MST')?.textContent || '';
                const serviceProviderTaxCode = xmlDoc.querySelector('MSTTCGP')?.textContent || '';
                
                // S·ª≠ d·ª•ng thu·∫≠t to√°n m·ªõi ƒë·ªÉ t√¨m m√£ tra c·ª©u
                const portalCodes = extractPortalCodes(xmlContent);
                const verificationCode = portalCodes.length > 0 ? portalCodes[0].code : '';
                
                // S·ª≠ d·ª•ng thu·∫≠t to√°n c·∫£i ti·∫øn ƒë·ªÉ t√¨m transaction ID
                const transactionID = findTransactionID(xmlDoc);
                
                const invoiceNumber = xmlDoc.querySelector('SHDon')?.textContent || '';
                
                // C·∫≠p nh·∫≠t d·ªØ li·ªáu to√†n c·ª•c
                invoiceData = {
                    sellerName,
                    sellerTaxCode,
                    serviceProviderTaxCode,
                    verificationCode,
                    transactionID,
                    invoiceNumber,
                    xmlContent: xmlContent,
                    portalCodes: portalCodes // L∆∞u t·∫•t c·∫£ c√°c m√£ t√¨m th·∫•y
                };
                
                console.log("üìä D·ªØ li·ªáu h√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω:", invoiceData);
                console.log("üîç C√°c m√£ tra c·ª©u t√¨m th·∫•y:", portalCodes);
                
                // T√¨m nh√† cung c·∫•p ph√π h·ª£p - Y√äU C·∫¶U 2
                matchedProviders = findMatchingProviders(serviceProviderTaxCode);
                
                // L∆∞u v√†o JSON - Y√äU C·∫¶U 1
                saveXmlToJson(xmlContent, 'invoice_data');
                
                return invoiceData;
            } catch (error) {
                console.error('L·ªói khi x·ª≠ l√Ω XML:', error);
                return null;
            }
        }

        // ==============================================
        // PH·∫¶N X·ª¨ L√ù CHO TAB 1: H√ìA ƒê∆†N GTGT - C·∫¢I THI·ªÜN
        // ==============================================

        // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu h√≥a ƒë∆°n GTGT
        let invoiceDataGtgt = {};
        let currentPageGtgt = 1;
        let totalPagesGtgt = 1;
        let paginatedInvoiceDataGtgt = [];
        let maxLinesPerPageGtgt = 10; // S·ªë d√≤ng m·∫∑c ƒë·ªãnh m·ªói trang

        // X·ª≠ l√Ω s·ª± ki·ªán khi ch·ªçn file cho tab GTGT
        document.getElementById('xmlFileGtgt').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'Ch∆∞a ch·ªçn file';
            document.getElementById('fileNameGtgt').textContent = `File ƒë√£ ch·ªçn: ${fileName}`;
        });

        // X·ª≠ l√Ω t·∫£i l√™n file XML cho tab GTGT
        document.getElementById('uploadBtnGtgt').addEventListener('click', function() {
            const fileInput = document.getElementById('xmlFileGtgt');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Vui l√≤ng ch·ªçn file XML tr∆∞·ªõc khi t·∫£i l√™n!');
                return;
            }
            
            document.getElementById('loadingGtgt').style.display = 'block';
            document.getElementById('invoicePreviewGtgt').style.display = 'none';
            document.getElementById('requestOriginalBtn').style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                setTimeout(() => {
                    const xmlText = e.target.result;
                    
                    // X·ª≠ l√Ω XML v√† l∆∞u v√†o JSON - Y√äU C·∫¶U 1 & 8
                    const processedData = processXmlData(xmlText);
                    
                    if (processedData) {
                        // X·ª≠ l√Ω d·ªØ li·ªáu XML cho h√≥a ƒë∆°n GTGT
                        const success = processXmlDataGtgtForDisplay(xmlText);
                        
                        if (success) {
                            // Ph√¢n trang d·ªØ li·ªáu
                            paginateInvoiceDataGtgt();
                            // Hi·ªÉn th·ªã trang ƒë·∫ßu ti√™n
                            showPageGtgt(1);
                            
                            document.getElementById('loadingGtgt').style.display = 'none';
                            document.getElementById('invoicePreviewGtgt').style.display = 'block';
                            document.getElementById('requestOriginalBtn').style.display = 'inline-block';
                        } else {
                            document.getElementById('loadingGtgt').style.display = 'none';
                        }
                    } else {
                        document.getElementById('loadingGtgt').style.display = 'none';
                        alert('C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω file XML.');
                    }
                }, 500);
            };
            
            reader.onerror = function() {
                alert('L·ªói khi ƒë·ªçc file. Vui l√≤ng th·ª≠ l·∫°i.');
                document.getElementById('loadingGtgt').style.display = 'none';
            };
            
            reader.readAsText(file);
        });

        // H√†m x·ª≠ l√Ω d·ªØ li·ªáu XML cho tab GTGT (hi·ªÉn th·ªã)
        function processXmlDataGtgtForDisplay(xmlText) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Ki·ªÉm tra l·ªói XML
                const parseError = xmlDoc.getElementsByTagName('parsererror');
                if (parseError.length > 0) {
                    alert('File XML kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i file.');
                    return false;
                }
                
                return processXmlDataGtgt(xmlDoc);
            } catch (error) {
                console.error('L·ªói khi x·ª≠ l√Ω XML:', error);
                alert('C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω file XML. Vui l√≤ng ki·ªÉm tra l·∫°i file.');
                return false;
            }
        }

        // H√†m x·ª≠ l√Ω d·ªØ li·ªáu XML cho tab GTGT
        function processXmlDataGtgt(xmlDoc) {
            try {
                // Reset d·ªØ li·ªáu
                invoiceDataGtgt = {};
                
                // L·∫•y th√¥ng tin chung
                const ttChung = xmlDoc.getElementsByTagName('TTChung')[0];
                if (!ttChung) {
                    alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin chung c·ªßa h√≥a ƒë∆°n');
                    return false;
                }
                
                invoiceDataGtgt.invoiceDate = formatDateGtgt(getElementTextGtgt(ttChung, 'NLap'));
                invoiceDataGtgt.serialNo = getElementTextGtgt(ttChung, 'KHHDon');
                invoiceDataGtgt.invoiceNo = getElementTextGtgt(ttChung, 'SHDon');
                invoiceDataGtgt.exchangeRate = getElementTextGtgt(ttChung, 'TGia', '1');
                invoiceDataGtgt.paymentMethod = getElementTextGtgt(ttChung, 'HTTToan', 'Ti·ªÅn m·∫∑t');
                
                // L·∫•y th√¥ng tin ng∆∞·ªùi b√°n
                const nBan = xmlDoc.getElementsByTagName('NBan')[0];
                if (nBan) {
                    invoiceDataGtgt.sellerName = getElementTextGtgt(nBan, 'Ten');
                    invoiceDataGtgt.sellerTaxCode = getElementTextGtgt(nBan, 'MST');
                    invoiceDataGtgt.sellerAddress = getElementTextGtgt(nBan, 'DChi');
                }
                
                // L·∫•y th√¥ng tin ng∆∞·ªùi mua
                const nMua = xmlDoc.getElementsByTagName('NMua')[0];
                if (nMua) {
                    invoiceDataGtgt.buyerName = getElementTextGtgt(nMua, 'Ten');
                    invoiceDataGtgt.buyerTaxCode = getElementTextGtgt(nMua, 'MST');
                    invoiceDataGtgt.buyerAddress = getElementTextGtgt(nMua, 'DChi');
                }
                
                // L·∫•y th√¥ng tin h√†ng h√≥a/d·ªãch v·ª•
                const dshhdvu = xmlDoc.getElementsByTagName('DSHHDVu')[0];
                invoiceDataGtgt.products = [];
                
                if (dshhdvu) {
                    const products = dshhdvu.getElementsByTagName('HHDVu');
                    for (let i = 0; i < products.length; i++) {
                        const product = products[i];
                        const thueSuat = getElementTextGtgt(product, 'TSuat', '0');
                        const tienThue = getElementTextGtgt(product, 'TThue', '0');
                        
                        invoiceDataGtgt.products.push({
                            stt: getElementTextGtgt(product, 'STT', (i + 1).toString()),
                            description: getElementTextGtgt(product, 'THHDVu'),
                            unit: getElementTextGtgt(product, 'DVTinh', ''),
                            quantity: getElementTextGtgt(product, 'SLuong', '1'),
                            unitPrice: getElementTextGtgt(product, 'DGia', '0'),
                            amount: getElementTextGtgt(product, 'ThTien', '0'),
                            taxRate: thueSuat,
                            taxAmount: tienThue
                        });
                    }
                }
                
                // L·∫•y th√¥ng tin t·ªïng thanh to√°n
                const tToan = xmlDoc.getElementsByTagName('TToan')[0];
                if (tToan) {
                    invoiceDataGtgt.totalAmount = getElementTextGtgt(tToan, 'TgTCThue', '0');
                    invoiceDataGtgt.vatAmount = getElementTextGtgt(tToan, 'TgTThue', '0');
                    invoiceDataGtgt.totalPayment = getElementTextGtgt(tToan, 'TgTTTBSo', '0');
                    invoiceDataGtgt.amountInWords = getElementTextGtgt(tToan, 'TgTTTBChu', '');
                }
                
                // L·∫•y th√¥ng tin m√£ tra c·ª©u v√† m√£ c∆° quan thu·∫ø
                // S·ª¨A ƒê·ªîI: L·∫•y textContent thay v√¨ thu·ªôc t√≠nh Id c·ªßa MCCQT
                const mccqt = xmlDoc.getElementsByTagName('MCCQT')[0];
                if (mccqt) {
                    invoiceDataGtgt.verificationCode = mccqt.textContent || '';
                    // S·ª¨A ƒê·ªîI: L·∫•y textContent thay v√¨ thu·ªôc t√≠nh Id
                    invoiceDataGtgt.taxAuthorityCode = mccqt.textContent || '';
                }
                
                // L·∫•y th√¥ng tin transaction ID t·ª´ DLHDon
                const dlhdon = xmlDoc.getElementsByTagName('DLHDon')[0];
                if (dlhdon) {
                    invoiceDataGtgt.transactionId = dlhdon.getAttribute('Id') || '';
                }
                
                return true;
            } catch (error) {
                console.error('L·ªói khi x·ª≠ l√Ω XML:', error);
                alert('C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω file XML. Vui l√≤ng ki·ªÉm tra l·∫°i file.');
                return false;
            }
        }

        // H√†m ph√¢n trang d·ªØ li·ªáu h√≥a ƒë∆°n cho tab GTGT
        function paginateInvoiceDataGtgt() {
            paginatedInvoiceDataGtgt = [];
            const allProducts = [...invoiceDataGtgt.products];
            
            // T√≠nh to√°n s·ªë d√≤ng t·ªëi ƒëa m·ªói trang d·ª±a tr√™n chi·ªÅu cao t√™n s·∫£n ph·∫©m
            maxLinesPerPageGtgt = calculateMaxLinesPerPageGtgt(allProducts);
            
            // N·∫øu s·ªë s·∫£n ph·∫©m √≠t h∆°n ho·∫∑c b·∫±ng maxLinesPerPage, t·∫•t c·∫£ s·∫Ω ·ªü trang cu·ªëi
            if (allProducts.length <= maxLinesPerPageGtgt) {
                paginatedInvoiceDataGtgt.push({
                    products: allProducts,
                    isLastPage: true,
                    pageNumber: 1,
                    totalPages: 1
                });
                totalPagesGtgt = 1;
                return;
            }
            
            // Ph√¢n trang
            let pageNumber = 1;
            let remainingProducts = [...allProducts];
            
            while (remainingProducts.length > 0) {
                const isLastPage = remainingProducts.length <= maxLinesPerPageGtgt;
                const productsForPage = remainingProducts.splice(0, isLastPage ? remainingProducts.length : maxLinesPerPageGtgt);
                
                paginatedInvoiceDataGtgt.push({
                    products: productsForPage,
                    isLastPage: isLastPage,
                    pageNumber: pageNumber,
                    totalPages: Math.ceil(allProducts.length / maxLinesPerPageGtgt)
                });
                
                pageNumber++;
            }
            
            totalPagesGtgt = paginatedInvoiceDataGtgt.length;
            
            // C·∫≠p nh·∫≠t totalPages cho t·∫•t c·∫£ c√°c trang
            paginatedInvoiceDataGtgt.forEach(page => {
                page.totalPages = totalPagesGtgt;
            });
        }

        // H√†m t√≠nh to√°n s·ªë d√≤ng t·ªëi ƒëa m·ªói trang cho tab GTGT - C·∫¢I THI·ªÜN
        function calculateMaxLinesPerPageGtgt(products) {
            // Chi·ªÅu cao c·ªë ƒë·ªãnh c·ªßa c√°c ph·∫ßn header v√† footer
            const headerHeight = 350; // Chi·ªÅu cao ∆∞·ªõc t√≠nh c·ªßa header (px)
            const footerHeight = 150; // Chi·ªÅu cao ∆∞·ªõc t√≠nh c·ªßa footer (px)
            const signatureHeight = 120; // Chi·ªÅu cao ph·∫ßn ch·ªØ k√Ω (ch·ªâ ·ªü trang cu·ªëi)
            const pageHeight = 297 * 3.78; // Chi·ªÅu cao A4 t√≠nh b·∫±ng px (297mm * 3.78px/mm)
            
            // T√≠nh chi·ªÅu cao trung b√¨nh c·ªßa m·ªói d√≤ng s·∫£n ph·∫©m
            let totalProductHeight = 0;
            let productCount = 0;
            
            products.forEach(product => {
                // ∆Ø·ªõc t√≠nh chi·ªÅu cao d·ª±a tr√™n ƒë·ªô d√†i t√™n s·∫£n ph·∫©m
                const descriptionLength = product.description ? product.description.length : 0;
                // M·ªói d√≤ng ch·ª©a kho·∫£ng 50 k√Ω t·ª±, m·ªói d√≤ng cao 20px
                const lines = Math.ceil(descriptionLength / 50);
                const productHeight = lines * 20;
                totalProductHeight += productHeight;
                productCount++;
            });
            
            const avgProductHeight = productCount > 0 ? totalProductHeight / productCount : 30;
            
            // T√≠nh s·ªë d√≤ng t·ªëi ƒëa c√≥ th·ªÉ ch·ª©a trong m·ªôt trang
            const availableHeight = pageHeight - headerHeight - footerHeight;
            const maxLines = Math.floor(availableHeight / avgProductHeight);
            
            // ƒê·∫£m b·∫£o √≠t nh·∫•t 5 d√≤ng v√† t·ªëi ƒëa 15 d√≤ng m·ªói trang
            return Math.max(5, Math.min(15, maxLines));
        }

        // H√†m hi·ªÉn th·ªã trang c·ª• th·ªÉ cho tab GTGT
        function showPageGtgt(pageNumber) {
            if (pageNumber < 1 || pageNumber > totalPagesGtgt) return;
            
            currentPageGtgt = pageNumber;
            const pageData = paginatedInvoiceDataGtgt[pageNumber - 1];
            
            // C·∫≠p nh·∫≠t th√¥ng tin trang
            document.getElementById('pageInfo').textContent = `Trang ${pageNumber} / ${totalPagesGtgt}`;
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t ƒëi·ªÅu h∆∞·ªõng
            document.getElementById('prevPageBtn').disabled = pageNumber === 1;
            document.getElementById('nextPageBtn').disabled = pageNumber === totalPagesGtgt;
            
            // T·∫°o n·ªôi dung cho trang hi·ªán t·∫°i
            const previewContent = document.getElementById('previewContentGtgt');
            const invoiceHtml = generateGtgtInvoicePage(pageData);
            previewContent.innerHTML = invoiceHtml;
        }

        // H√†m l·∫•y text t·ª´ element cho tab GTGT
        function getElementTextGtgt(parentElement, tagName, defaultValue = '') {
            const elements = parentElement.getElementsByTagName(tagName);
            return elements.length > 0 ? elements[0].textContent : defaultValue;
        }

        // H√†m ƒë·ªãnh d·∫°ng ng√†y cho tab GTGT
        function formatDateGtgt(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${day} th√°ng ${month} nƒÉm ${year}`;
            } catch (e) {
                return dateString;
            }
        }

        // H√†m ƒë·ªãnh d·∫°ng s·ªë cho tab GTGT - L√ÄM TR√íN CH·ªà L·∫§Y PH·∫¶N NGUY√äN
        function formatNumberGtgt(numberStr) {
            if (!numberStr) return '';
            const number = parseFloat(numberStr.replace(/[^\d.]/g, ''));
            if (isNaN(number)) return '';
            // L√†m tr√≤n ch·ªâ l·∫•y ph·∫ßn nguy√™n
            return Math.round(number).toLocaleString('vi-VN');
        }

        // H√†m ƒë·ªãnh d·∫°ng s·ªë cho tab GTGT - N·∫øu b·∫±ng 0 th√¨ kh√¥ng hi·ªÉn th·ªã
        function formatNumberGtgtZero(numberStr) {
            if (!numberStr) return '';
            const number = parseFloat(numberStr.replace(/[^\d.]/g, ''));
            if (isNaN(number) || number === 0) return '';
            // L√†m tr√≤n ch·ªâ l·∫•y ph·∫ßn nguy√™n
            return Math.round(number).toLocaleString('vi-VN');
        }

        // H√†m ƒë·ªãnh d·∫°ng thu·∫ø su·∫•t
        function formatTaxRateGtgt(taxRateStr) {
            if (!taxRateStr) return '';
            const taxRate = parseFloat(taxRateStr);
            if (isNaN(taxRate) || taxRate === 0) return '';
            return taxRate + '%';
        }

        // T·∫°o n·ªôi dung h√≥a ƒë∆°n GTGT cho m·ªôt trang c·ª• th·ªÉ - C·∫¢I THI·ªÜN V·ªöI Y√äU C·∫¶U 3
        function generateGtgtInvoicePage(pageData) {
            const isLastPage = pageData.isLastPage;
            const pageNumber = pageData.pageNumber;
            const totalPages = pageData.totalPages;
            
            // T·∫°o danh s√°ch s·∫£n ph·∫©m cho trang n√†y
            let productsHtml = '';
            const productsForPage = pageData.products;
            
            // Th√™m c√°c d√≤ng s·∫£n ph·∫©m th·ª±c t·∫ø
            productsForPage.forEach((product, index) => {
                productsHtml += `
                    <tr>
                        <td align="center" class="invoice-gtgt-item-normal">${product.stt}</td>
                        <td align="left" class="invoice-gtgt-item-normal">${product.description}</td>
                        <td align="center" class="invoice-gtgt-item-normal">${product.unit}</td>
                        <td align="right" class="invoice-gtgt-item-normal">${formatNumberGtgtZero(product.quantity)}</td>
                        <td align="right" class="invoice-gtgt-item-normal">${formatNumberGtgtZero(product.unitPrice)}</td>
                        <td align="right" class="invoice-gtgt-item-normal">${formatNumberGtgtZero(product.amount)}</td>
                    </tr>
                `;
            });
            
            // N·∫øu l√† trang ƒë·∫ßu ti√™n v√† s·ªë d√≤ng √≠t h∆°n maxLinesPerPage, th√™m c√°c d√≤ng tr·ªëng
            if (pageNumber === 1 && productsForPage.length < maxLinesPerPageGtgt) {
                const emptyRows = maxLinesPerPageGtgt - productsForPage.length;
                for (let i = 0; i < emptyRows; i++) {
                    productsHtml += `
                        <tr>
                            <td align="center" class="invoice-gtgt-item-normal">&nbsp;</td>
                            <td align="left" class="invoice-gtgt-item-normal">&nbsp;</td>
                            <td align="center" class="invoice-gtgt-item-normal">&nbsp;</td>
                            <td align="right" class="invoice-gtgt-item-normal">&nbsp;</td>
                            <td align="right" class="invoice-gtgt-item-normal">&nbsp;</td>
                            <td align="right" class="invoice-gtgt-item-normal">&nbsp;</td>
                        </tr>
                    `;
                }
            }
            
            // L·∫•y th√¥ng tin nh√† cung c·∫•p d·ªãch v·ª• t·ª´ XML
            const serviceProviderTaxCode = invoiceDataGtgt.serviceProviderTaxCode || invoiceData.serviceProviderTaxCode || '';
            const serviceProviderName = getServiceProviderName(serviceProviderTaxCode);
            
            // L·∫•y m√£ tra c·ª©u t·ª´ k·∫øt qu·∫£ h√†m extractPortalCodes
            const portalCodes = invoiceData.portalCodes || [];
            const verificationCode = portalCodes.length > 0 ? portalCodes[0].code : invoiceDataGtgt.verificationCode || '';
            
            return `
                <div class="invoice-gtgt-container force-times-new-roman">
                    <table ALIGN="center" class="invoice-gtgt-box-large">
                        <!-- Header - Hi·ªÉn th·ªã tr√™n t·∫•t c·∫£ c√°c trang -->
                        <tr class="invoice-gtgt-border-bottom">
                            <td width="24%" align="center">
                                <div class="image-box">
                                    <!-- Logo s·∫Ω ƒë∆∞·ª£c th√™m ·ªü ƒë√¢y -->
                                </div>
                            </td>
                            <td width="48%" align="center">
                                <font class="invoice-gtgt-label-bold" style="font-size: 18px;">
                                    H√ìA ƒê∆†N GI√Å TR·ªä GIA TƒÇNG
                                </font>
                                <br>
                                <font class="invoice-gtgt-label-bold" style="font-size: 16px;">
                                    (VAT INVOICE)
                                </font>
                                <br>
                                <font class="invoice-gtgt-label-bold">B·∫£n th·ªÉ hi·ªán c·ªßa h√≥a ƒë∆°n ƒëi·ªán t·ª≠</font>
                                <br>
                                <font class="invoice-gtgt-label-italic">
                                    (Electronic invoice display)
                                </font>
                                <br>
                                <font class="invoice-gtgt-label-normal">Ng√†y </font>
                                <font class="invoice-gtgt-label-italic">(date) </font>
                                <span>${invoiceDataGtgt.invoiceDate}</span>
                            </td>
                            <td width="28%" class="invoice-gtgt-vertical-top">
                                <table align="right" class="invoice-gtgt-box-small invoice-gtgt-no-border">
                                    <tr>
                                        <td align="left">
                                            <font class="invoice-gtgt-label-bold">K√Ω hi·ªáu</font>
                                            <font class="invoice-gtgt-label-italic">(Serial): </font>
                                        </td>
                                        <td align="left" class="invoice-gtgt-item-bold">
                                            ${invoiceDataGtgt.serialNo || '.........'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td align="left">
                                            <font class="invoice-gtgt-label-bold">S·ªë</font>
                                            <font class="invoice-gtgt-label-italic">(No.): </font>
                                        </td>
                                        <td align="left" class="invoice-gtgt-item-bold">
                                            ${invoiceDataGtgt.invoiceNo || '.........'}
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>

                        <tr class="invoice-gtgt-border-bottom">
                            <td colspan="3">
                                <table class="invoice-gtgt-width-100">
                                    <tr>
                                        <td>
                                            <font class="invoice-gtgt-label-bold">ƒê∆°n v·ªã b√°n h√†ng</font>
                                            <font class="invoice-gtgt-label-italic">(Issued): </font>
                                            <font class="invoice-gtgt-label-bold">${invoiceDataGtgt.sellerName || '.........................................'}</font>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <font class="invoice-gtgt-label-bold">M√£ s·ªë thu·∫ø</font>
                                            <font class="invoice-gtgt-label-italic">(Tax code): </font>
                                            <font class="invoice-gtgt-label-bold">${invoiceDataGtgt.sellerTaxCode || '.........................................'}</font>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <font class="invoice-gtgt-label-bold">ƒê·ªãa ch·ªâ</font>
                                            <font class="invoice-gtgt-label-italic">(Address): </font>
                                            <font class="invoice-gtgt-label-bold">${invoiceDataGtgt.sellerAddress || '.........................................'}</font>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>

                        <tr>
                            <td colspan="3">
                                <table class="invoice-gtgt-width-100">
                                    <tr>
                                        <td>
                                            <font class="invoice-gtgt-label-bold">H·ªç t√™n ng∆∞·ªùi mua h√†ng</font>
                                            <font class="invoice-gtgt-label-italic">(Buyer name): </font>
                                            <font class="invoice-gtgt-item-normal">${invoiceDataGtgt.buyerName || '.........................................'}</font>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <font class="invoice-gtgt-label-bold">T√™n ƒë∆°n v·ªã</font>
                                            <font class="invoice-gtgt-label-italic">(Company name): </font>
                                            <font class="invoice-gtgt-item-normal">${invoiceDataGtgt.buyerName || '.........................................'}</font>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <font class="invoice-gtgt-label-bold">M√£ s·ªë thu·∫ø</font>
                                            <font class="invoice-gtgt-label-italic">(Tax code): </font>
                                            <font class="invoice-gtgt-item-bold">${invoiceDataGtgt.buyerTaxCode || '.........................................'}</font>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <font class="invoice-gtgt-label-bold">ƒê·ªãa ch·ªâ</font>
                                            <font class="invoice-gtgt-label-italic">(Address): </font>
                                            <font class="invoice-gtgt-item-normal">${invoiceDataGtgt.buyerAddress || '.........................................'}</font>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>

                        <tr>
                            <td colspan="3">
                                <table class="invoice-gtgt-width-100 invoice-gtgt-box-small">
                                    <tr>
                                        <td width="5%" align="center">
                                            <font class="invoice-gtgt-label-bold">STT</font>
                                            <br>
                                            <font class="invoice-gtgt-label-italic">(No.)</font>
                                        </td>
                                        <td width="35%" align="center">
                                            <font class="invoice-gtgt-label-bold">T√™n h√†ng h√≥a, d·ªãch v·ª•</font>
                                            <br>
                                            <font class="invoice-gtgt-label-italic">(Description)</font>
                                        </td>
                                        <td width="7%" align="center">
                                            <font class="invoice-gtgt-label-bold">ƒêVT</font>
                                            <br>
                                            <font class="invoice-gtgt-label-italic">(Unit)</font>
                                        </td>
                                        <td width="7%" align="center">
                                            <font class="invoice-gtgt-label-bold">S·ªë l∆∞·ª£ng</font>
                                            <br>
                                            <font class="invoice-gtgt-label-italic">(Quantity)</font>
                                        </td>
                                        <td width="10%" align="center">
                                            <font class="invoice-gtgt-label-bold">ƒê∆°n gi√°</font>
                                            <br>
                                            <font class="invoice-gtgt-label-italic">(Unit price)</font>
                                        </td>
                                        <td width="12%" align="center">
                                            <font class="invoice-gtgt-label-bold">Th√†nh ti·ªÅn</font>
                                            <br>
                                            <font class="invoice-gtgt-label-italic">(Amount)</font>
                                        </td>
                                    </tr>
                                    ${productsHtml}
                                    ${isLastPage ? `
                                        <!-- T·ªïng ti·ªÅn h√†ng - C·∫¨P NH·∫¨T THEO Y√äU C·∫¶U 3 -->
                                        <tr>
                                            <td class="text-right box-small" colspan="5">
                                                <span class="label-bold">C·ªông ti·ªÅn h√†ng</span>
                                                <span class="label-italic">(Total amount):</span>
                                            </td>
                                            <td class="text-right box-small item-bold">${formatNumberGtgt(invoiceDataGtgt.totalAmount)}</td>
                                        </tr>

                                        <!-- Thu·∫ø GTGT - C·∫¨P NH·∫¨T THEO Y√äU C·∫¶U 3 -->
                                        <tr>
                                            <td class="text-left box-small label-normal" colspan="2">
                                                <span class="label-bold">Thu·∫ø su·∫•t GTGT</span>
                                                <span class="label-italic">(VAT rate):</span>
                                                <span class="label-normal">10%</span>
                                            </td>
                                            <td class="text-right box-small label-normal" colspan="3">
                                                <span class="label-bold">Ti·ªÅn thu·∫ø GTGT </span>
                                                <span class="label-italic">(VAT amount):</span>
                                            </td>
                                            <td class="text-right box-small item-normal">${formatNumberGtgt(invoiceDataGtgt.vatAmount)}</td>
                                        </tr>

                                        <!-- T·ªïng thanh to√°n - C·∫¨P NH·∫¨T THEO Y√äU C·∫¶U 3 -->
                                        <tr>
                                            <td class="text-right box-small" colspan="5">
                                                <span class="label-bold">T·ªïng c·ªông ti·ªÅn thanh to√°n</span>
                                                <span class="label-italic">(Total payment):</span>
                                            </td>
                                            <td class="text-right box-small item-bold">${formatNumberGtgt(invoiceDataGtgt.totalPayment)}</td>
                                        </tr>

                                        <!-- S·ªë ti·ªÅn vi·∫øt b·∫±ng ch·ªØ -->
                                        <tr>
                                            <td class="text-left box-small" colspan="6">
                                                <span class="label-bold">S·ªë ti·ªÅn vi·∫øt b·∫±ng ch·ªØ</span>
                                                <span class="label-italic">(Amount in words):</span>
                                                <span class="item-normal">${invoiceDataGtgt.amountInWords || '.........................................'}</span>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </table>
                            </td>
                        </tr>

                        <!-- CH·ªà HI·ªÇN TH·ªä CH·ªÆ K√ù ·ªû TRANG CU·ªêI -->
                        ${isLastPage ? `
                        <tr>
                            <td colspan="3">
                                <table class="invoice-gtgt-width-100">
                                    <tr>
                                        <td align="center" class="invoice-gtgt-width-100">
                                            <font class="invoice-gtgt-label-bold">Ng∆∞·ªùi mua h√†ng</font>
                                            <font class="invoice-gtgt-label-italic">(Buyer)</font>
                                        </td>
                                        <td align="center" class="invoice-gtgt-width-100">
                                            <font class="invoice-gtgt-label-bold">Ng∆∞·ªùi b√°n h√†ng</font>
                                            <font class="invoice-gtgt-label-italic">(Seller)</font>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td align="center">
                                            <div style="height: 80px; border-bottom: 1px solid #000; width: 200px; margin: 0 auto;">
                                                <!-- ƒê·ªÉ tr·ªëng ph·∫ßn ch·ªØ k√Ω c·ªßa b√™n mua -->
                                            </div>
                                        </td>
                                        <td align="center">
                                            <div style="height: 80px; border-bottom: 1px solid #ff0000; width: 200px; margin: 0 auto;">
                                                <font class="invoice-gtgt-label-bold" style="color: #ff0000;">
                                                    ‚úÖ K√Ω b·ªüi ${invoiceDataGtgt.sellerName || '.........................................'}
                                                </font>
                                                <br>
                                                <font class="invoice-gtgt-label-italic" style="color: #ff0000;">
                                                    (Ch·ªØ k√Ω s·ªë)
                                                </font>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                        ` : ''}
                        
                        <!-- Th√¥ng tin m√£ tra c·ª©u v√† m√£ c∆° quan thu·∫ø - HI·ªÜN TR√äN T·∫§T C·∫¢ C√ÅC TRANG -->
                        <tr>
                            <td colspan="3">
                                
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Footer v·ªõi m√£ CQT v√† m√£ tra c·ª©u - HI·ªÜN TR√äN T·∫§T C·∫¢ C√ÅC TRANG -->
                    <div class="footer">
                        <div class="label-italic">(C·∫ßn ki·ªÉm tra ƒë·ªëi chi·∫øu khi l·∫≠p, giao, nh·∫≠n h√≥a ƒë∆°n)</div>
                        
                        <!-- M√£ CQT v√† m√£ tra c·ª©u -->
                        <div class="cqt-info">
                            <div class="label-italic">M√£ c∆° quan thu·∫ø: <span class="cqt-code">${invoiceDataGtgt.taxAuthorityCode || '.........................................'}</span></div>
                            <div class="label-italic">M√£ tra c·ª©u: <span class="cqt-code">${verificationCode || '.........................................'}</span></div>
                        </div>
                        
                        <div class="label-italic">ƒê∆°n v·ªã cung c·∫•p d·ªãch v·ª• H√≥a ƒë∆°n ƒëi·ªán t·ª≠: ${serviceProviderName}, MST: ${serviceProviderTaxCode}</div>
                        <div class="label-italic">
                            Tra c·ª©u h√≥a ƒë∆°n ƒëi·ªán t·ª≠ t·∫°i Website: ${getServiceProviderUrl(serviceProviderTaxCode)}
                        </div>
                        <div class="label-italic" style="margin-top: 5px;">
                            Ho·∫∑c tra c·ª©u t·∫°i C·ªïng th√¥ng tin ƒëi·ªán t·ª≠ c·ªßa T·ªïng c·ª•c Thu·∫ø: https://tracuuhoadon.gdt.gov.vn
                        </div>
                    </div>
                    
                    <!-- S·ªë trang - HI·ªÜN TR√äN T·∫§T C·∫¢ C√ÅC TRANG -->
                    <div class="page-number">Trang ${pageNumber}/${totalPages}</div>
                </div>
            `;
        }

        // H√†m l·∫•y t√™n nh√† cung c·∫•p d·ªãch v·ª• t·ª´ MSTTCGP
        function getServiceProviderName(taxCode) {
            if (!taxCode) return '.........................................';
            const provider = serviceProviders.find(p => p.mst === taxCode);
            return provider ? provider.name : '.........................................';
        }

        // H√†m l·∫•y URL nh√† cung c·∫•p d·ªãch v·ª• t·ª´ MSTTCGP
        function getServiceProviderUrl(taxCode) {
            if (!taxCode) return '.........................................';
            const provider = serviceProviders.find(p => p.mst === taxCode);
            return provider ? provider.url : '.........................................';
        }

        // T·∫°o preview h√≥a ƒë∆°n ƒë·∫ßy ƒë·ªß cho modal
        function generateFullGtgtInvoice() {
            let fullInvoiceHtml = '';
            
            for (let i = 0; i < paginatedInvoiceDataGtgt.length; i++) {
                const pageData = paginatedInvoiceDataGtgt[i];
                fullInvoiceHtml += generateGtgtInvoicePage(pageData);
            }
            
            return fullInvoiceHtml;
        }

        // X·ª≠ l√Ω s·ª± ki·ªán ph√¢n trang cho tab GTGT
        document.getElementById('prevPageBtn').addEventListener('click', function() {
            if (currentPageGtgt > 1) {
                showPageGtgt(currentPageGtgt - 1);
            }
        });

        document.getElementById('nextPageBtn').addEventListener('click', function() {
            if (currentPageGtgt < totalPagesGtgt) {
                showPageGtgt(currentPageGtgt + 1);
            }
        });

        // Hi·ªÉn th·ªã modal h√≥a ƒë∆°n cho tab GTGT
        document.getElementById('showModalBtnGtgt').addEventListener('click', function() {
            const modalContent = document.getElementById('modalInvoiceContentGtgt');
            const invoiceHtml = generateFullGtgtInvoice();
            modalContent.innerHTML = invoiceHtml;
            document.getElementById('invoiceModalGtgt').style.display = 'block';
        });

        // ƒê√≥ng modal h√≥a ƒë∆°n cho tab GTGT
        document.getElementById('closeModalBtnGtgt').addEventListener('click', closeInvoiceModalGtgt);
        document.getElementById('closeModalBtn2Gtgt').addEventListener('click', closeInvoiceModalGtgt);
        
        function closeInvoiceModalGtgt() {
            document.getElementById('invoiceModalGtgt').style.display = 'none';
        }

        // In h√≥a ƒë∆°n cho tab GTGT
        document.getElementById('printInvoiceBtnGtgt').addEventListener('click', function() {
            window.print();
        });

        // T·∫£i PDF t·ª´ modal cho tab GTGT - C·∫¨P NH·∫¨T THEO Y√äU C·∫¶U 2
        document.getElementById('downloadModalPdfBtnGtgt').addEventListener('click', function() {
            generatePDFWithScreenshotGtgt();
        });

        // T·∫£i PDF t·ª´ preview cho tab GTGT - C·∫¨P NH·∫¨T THEO Y√äU C·∫¶U 2
        document.getElementById('downloadPdfGtgt').addEventListener('click', function() {
            generatePDFWithScreenshotGtgt();
        });

        // Y√äU C·∫¶U 7: X·ª≠ l√Ω y√™u c·∫ßu h√≥a ƒë∆°n g·ªëc
        document.getElementById('requestOriginalBtn').addEventListener('click', function() {
            // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu t·ª´ XML kh√¥ng
            const jsonData = loadJsonFromStorage();
            if (!jsonData || !jsonData.processedData) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu h√≥a ƒë∆°n. Vui l√≤ng t·∫£i l√™n file XML tr∆∞·ªõc.');
                return;
            }
            
            // C·∫≠p nh·∫≠t d·ªØ li·ªáu to√†n c·ª•c t·ª´ JSON - Y√äU C·∫¶U 7 & 8
            invoiceData = jsonData.processedData;
            matchedProviders = findMatchingProviders(invoiceData.serviceProviderTaxCode);
            
            // M·ªü modal tra c·ª©u v·ªõi th√¥ng tin ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô
            document.getElementById('openLookupModalBtn').click();
            
            alert('ƒê√£ ƒë·ªìng b·ªô MSTTCGP t·ª´ h√≥a ƒë∆°n GTGT. Vui l√≤ng ch·ªçn nh√† cung c·∫•p trong modal tra c·ª©u.');
        });

        // H√†m t·∫£i PDF s·ª≠ d·ª•ng ph∆∞∆°ng ph√°p ch·ª•p ·∫£nh t·ª´ng trang cho tab GTGT - C·∫¢I THI·ªÜN V·ªöI Y√äU C·∫¶U 2
        async function generatePDFWithScreenshotGtgt() {
            // Hi·ªÉn th·ªã tr·∫°ng th√°i x·ª≠ l√Ω
            const processingStatus = document.getElementById('pdfProcessingStatus');
            const progressBar = document.getElementById('pdfProgressBar');
            const statusMessage = document.getElementById('pdfStatusMessage');
            
            processingStatus.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            statusMessage.textContent = 'ƒêang chu·∫©n b·ªã t·∫°o PDF...';

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Thi·∫øt l·∫≠p metadata
                pdf.setProperties({
                    title: `H√≥a ƒë∆°n GTGT ${invoiceDataGtgt.invoiceNo}`,
                    subject: 'H√≥a ƒë∆°n gi√° tr·ªã gia tƒÉng',
                    author: 'C√¥ng c·ª• chuy·ªÉn ƒë·ªïi XML to PDF'
                });

                // T·∫°o t·ª´ng trang v√† ch·ª•p ·∫£nh ri√™ng bi·ªát
                for (let i = 0; i < paginatedInvoiceDataGtgt.length; i++) {
                    const pageData = paginatedInvoiceDataGtgt[i];
                    
                    // C·∫≠p nh·∫≠t ti·∫øn tr√¨nh
                    const progress = Math.round(((i + 1) / paginatedInvoiceDataGtgt.length) * 100);
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${progress}%`;
                    statusMessage.textContent = `ƒêang x·ª≠ l√Ω trang ${i + 1}/${paginatedInvoiceDataGtgt.length}...`;

                    // T·∫°o n·ªôi dung trang trong container ·∫©n
                    const captureContainer = document.getElementById('captureContainer');
                    const invoiceHtml = generateGtgtInvoicePage(pageData);
                    captureContainer.innerHTML = invoiceHtml;

                    // ƒê·∫£m b·∫£o font Times New Roman ƒë∆∞·ª£c √°p d·ª•ng
                    captureContainer.classList.add('force-times-new-roman');
                    captureContainer.querySelectorAll('*').forEach(el => {
                        el.classList.add('force-times-new-roman');
                    });

                    // Ch·ªù m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ render
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Ch·ª•p ·∫£nh container v·ªõi scale cao ƒë·ªÉ tƒÉng DPI/PPI - Y√äU C·∫¶U 2
                    const canvas = await html2canvas(captureContainer, {
                        scale: 4, // TƒÉng scale l√™n 4 ƒë·ªÉ ƒë·∫°t DPI/PPI ~1200
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        width: captureContainer.scrollWidth,
                        height: captureContainer.scrollHeight,
                        onclone: function(clonedDoc) {
                            // ƒê·∫£m b·∫£o font ƒë∆∞·ª£c √°p d·ª•ng trong clone
                            clonedDoc.querySelectorAll('*').forEach(el => {
                                el.style.fontFamily = 'Times New Roman, Times, serif !important';
                            });
                        }
                    });

                    // T√≠nh to√°n k√≠ch th∆∞·ªõc ƒë·ªÉ fit v√†o trang A4
                    const imgWidth = 210; // A4 width in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    // Th√™m ·∫£nh v√†o PDF (th√™m trang m·ªõi n·∫øu kh√¥ng ph·∫£i trang ƒë·∫ßu)
                    if (i > 0) {
                        pdf.addPage();
                    }

                    // Th√™m ·∫£nh v√†o PDF
                    const imgData = canvas.toDataURL('image/jpeg', 0.95); // Ch·∫•t l∆∞·ª£ng cao
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                }

                // C·∫≠p nh·∫≠t ti·∫øn tr√¨nh cu·ªëi c√πng
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                statusMessage.textContent = 'ƒêang l∆∞u file...';

                // L∆∞u PDF
                const fileName = `HOA_DON_GTGT_${invoiceDataGtgt.invoiceNo || 'UNKNOWN'}.pdf`;
                pdf.save(fileName);

                // ·∫®n tr·∫°ng th√°i x·ª≠ l√Ω
                processingStatus.style.display = 'none';

                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                alert(`‚úÖ PDF ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng v·ªõi ${paginatedInvoiceDataGtgt.length} trang!`);

            } catch (error) {
                console.error('L·ªói khi t·∫°o PDF:', error);
                processingStatus.style.display = 'none';
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi t·∫°o PDF. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // ==============================================
        // PH·∫¶N X·ª¨ L√ù CHO TAB 2: TRA C·ª®U H√ìA ƒê∆†N - FIX L·ªñI
        // ==============================================

        // M·ªü modal tra c·ª©u - ƒê√É ƒê∆Ø·ª¢C S·ª¨A
        document.getElementById('openLookupModalBtn').addEventListener('click', function() {
            // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu h√≥a ƒë∆°n t·ª´ XML kh√¥ng
            const jsonData = loadJsonFromStorage();
            if (!jsonData || !jsonData.processedData) {
                alert('Vui l√≤ng t·∫£i l√™n file XML h√≥a ƒë∆°n tr∆∞·ªõc khi s·ª≠ d·ª•ng ch·ª©c nƒÉng tra c·ª©u!');
                return;
            }
            
            // C·∫≠p nh·∫≠t d·ªØ li·ªáu t·ª´ JSON - Y√äU C·∫¶U 1 & 2
            invoiceData = jsonData.processedData;
            matchedProviders = findMatchingProviders(invoiceData.serviceProviderTaxCode);
            
            // Kh·ªüi t·∫°o danh s√°ch nh√† cung c·∫•p d·ª±a tr√™n MSTTCGP - Y√äU C·∫¶U 2
            initializeProviders();
            
            // HI·ªÇN TH·ªä TH√îNG TIN H√ìA ƒê∆†N T·ª™ XML - ƒê√É ƒê∆Ø·ª¢C TH√äM - Y√äU C·∫¶U 6
            displayInvoiceInfoInModal();
            
            // Hi·ªÉn th·ªã m√£ tra c·ª©u n·∫øu c√≥
            if (invoiceData.verificationCode) {
                document.getElementById('lookupCode').value = invoiceData.verificationCode;
            }
            
            // Hi·ªÉn th·ªã danh s√°ch nh√† cung c·∫•p
            displayProviderList();
            
            // Reset tr·∫°ng th√°i
            document.getElementById('directPdfInfo').style.display = 'none';
            document.getElementById('lookupCodeGroup').style.display = 'block';
            document.getElementById('lookupResult').style.display = 'none';
            document.getElementById('directLookupSection').style.display = 'none';
            
            document.getElementById('lookupModal').style.display = 'block';
        });

        // H√ÄM HI·ªÇN TH·ªä TH√îNG TIN H√ìA ƒê∆†N TRONG MODAL - ƒê√É ƒê∆Ø·ª¢C TH√äM - Y√äU C·∫¶U 6
        function displayInvoiceInfoInModal() {
            const invoiceInfoContainer = document.getElementById('invoiceInfoFromXml');
            const invoiceInfoDetails = document.getElementById('invoiceInfoDetails');
            
            if (!invoiceData.sellerTaxCode) {
                invoiceInfoContainer.style.display = 'none';
                return;
            }
            
            const infoHtml = `
                <div class="info-item">
                    <span class="info-label">ƒê∆°n v·ªã b√°n h√†ng:</span>
                    <span class="info-value">${invoiceData.sellerName || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">MST ng∆∞·ªùi b√°n:</span>
                    <span class="info-value">${invoiceData.sellerTaxCode || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">M√£ tra c·ª©u:</span>
                    <span class="info-value">${invoiceData.verificationCode || 'N/A'}</span>
                </div>
                ${invoiceData.portalCodes && invoiceData.portalCodes.length > 0 ? `
                <div class="info-item">
                    <span class="info-label">C√°c m√£ t√¨m th·∫•y:</span>
                    <span class="info-value">
                        ${invoiceData.portalCodes.map(code => `${code.code} (${code.type})`).join(', ')}
                    </span>
                </div>
                ` : ''}
            `;
            
            invoiceInfoDetails.innerHTML = infoHtml;
            invoiceInfoContainer.style.display = 'block';
        }

        // X·ª≠ l√Ω s·ª± ki·ªán cho tab trong modal tra c·ª©u
        document.querySelectorAll('#lookupModal .tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // X√≥a active class t·ª´ t·∫•t c·∫£ c√°c tab v√† n·ªôi dung
                document.querySelectorAll('#lookupModal .tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('#lookupModal .tab-content').forEach(c => c.classList.remove('active'));
                
                // Th√™m active class cho tab ƒë∆∞·ª£c ch·ªçn
                this.classList.add('active');
                
                // Hi·ªÉn th·ªã n·ªôi dung t∆∞∆°ng ·ª©ng
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // T√¨m ki·∫øm nh√† cung c·∫•p
        document.getElementById('providerSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('.provider-table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // X·ª≠ l√Ω khi ch·ªçn nh√† cung c·∫•p trong dropdown - ƒê√É ƒê∆Ø·ª¢C S·ª¨A
        document.getElementById('providerSelect').addEventListener('change', function() {
            const selectedValue = this.value;
            const selectedOption = this.options[this.selectedIndex];
            const providerMST = selectedValue;
            const lookupCode = document.getElementById('lookupCode').value.trim() || invoiceData.verificationCode;
            const transactionID = invoiceData.transactionID;
            const sellerTaxCode = invoiceData.sellerTaxCode;
            
            // Y√äU C·∫¶U 3: N·∫øu MSTTCGP tr√πng v·ªõi function th√¨ l·∫•y link t·ª´ function
            let pdfDownloadInfo = null;
            
            if (providerMST === MISA_FUNCTION.mst) {
                // Function MISA
                const misaResult = MISA_FUNCTION.processXml(invoiceData.xmlContent);
                if (misaResult.success) {
                    pdfDownloadInfo = {
                        provider: MISA_FUNCTION,
                        pdfUrl: misaResult.data.pdfUrl,
                        requiresCode: false,
                        autoFillSupported: true
                    };
                }
            } else if (providerMST === BKAV_FUNCTION.id) {
                // Function BKAV
                const bkavResult = BKAV_FUNCTION.generateFromXML(invoiceData.xmlContent);
                if (bkavResult.success) {
                    pdfDownloadInfo = {
                        provider: BKAV_FUNCTION,
                        pdfUrl: bkavResult.data.downloadLink,
                        requiresCode: false,
                        autoFillSupported: true
                    };
                }
            } else if (providerMST === VIENH_HY_FUNCTION.mst) {
                // Function Vƒ©nh Hy
                const vinhHyResult = VIENH_HY_FUNCTION.processXml(invoiceData.xmlContent);
                if (vinhHyResult.success) {
                    pdfDownloadInfo = {
                        provider: VIENH_HY_FUNCTION,
                        pdfUrl: vinhHyResult.data.pdfUrl,
                        requiresCode: false,
                        autoFillSupported: true
                    };
                }
            } else if (providerMST === EASYINVOICE_MODULE.mst) {
                // Module EasyInvoice
                const jsonData = loadJsonFromStorage();
                if (jsonData) {
                    const easyInvoiceResult = createEasyInvoiceLookupURL(jsonData);
                    if (easyInvoiceResult.success) {
                        pdfDownloadInfo = {
                            provider: EASYINVOICE_MODULE,
                            pdfUrl: easyInvoiceResult.lookupUrl,
                            requiresCode: false,
                            autoFillSupported: true
                        };
                    }
                }
            } else {
                // C√°c nh√† cung c·∫•p kh√°c - Y√äU C·∫¶U 4
                pdfDownloadInfo = checkDirectPdfDownloadSupport(providerMST, lookupCode);
            }
            
            // Ki·ªÉm tra URL tra c·ª©u ƒë·∫∑c bi·ªát
            const specialLookupUrl = createSpecialLookupUrl(providerMST, transactionID, sellerTaxCode, lookupCode);
            
            // T·∫°o URL t·ª± ƒë·ªông ƒëi·ªÅn
            const autoFillUrl = createAutoFillUrl(providerMST, sellerTaxCode, lookupCode, transactionID);
            
            const directPdfInfo = document.getElementById('directPdfInfo');
            
            if (pdfDownloadInfo || specialLookupUrl || autoFillUrl) {
                let infoContent = '';
                
                if (pdfDownloadInfo && pdfDownloadInfo.pdfUrl) {
                    // C√≥ th·ªÉ t·∫£i tr·ª±c ti·∫øp
                    infoContent += `
                        <h4>üéâ C√≥ th·ªÉ t·∫£i PDF tr·ª±c ti·∫øp!</h4>
                        <p>Nh√† cung c·∫•p <strong>${pdfDownloadInfo.provider.name}</strong> h·ªó tr·ª£ t·∫£i h√≥a ƒë∆°n PDF tr·ª±c ti·∫øp.</p>
                        <p>${pdfDownloadInfo.provider.description || 'H·ªó tr·ª£ t·∫£i PDF t·ª´ nh√† cung c·∫•p'}</p>
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="${pdfDownloadInfo.pdfUrl}" target="_blank" class="direct-pdf-link">
                                üì• T·∫£i h√≥a ƒë∆°n PDF t·ª´ ${pdfDownloadInfo.provider.name}
                            </a>
                        </div>
                    `;
                }
                
                if (specialLookupUrl) {
                    infoContent += `
                        <h4>üîó Li√™n k·∫øt tra c·ª©u ƒë·∫∑c bi·ªát</h4>
                        <p>Nh√† cung c·∫•p <strong>${selectedOption.getAttribute('data-provider-name')}</strong> c√≥ li√™n k·∫øt tra c·ª©u ƒë·∫∑c bi·ªát.</p>
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="${specialLookupUrl}" target="_blank" class="direct-pdf-link">
                                üîç Truy c·∫≠p trang tra c·ª©u ${selectedOption.getAttribute('data-provider-name')}
                            </a>
                        </div>
                    `;
                }
                
                if (autoFillUrl && pdfDownloadInfo && pdfDownloadInfo.autoFillSupported) {
                    infoContent += `
                        <h4>ü§ñ Li√™n k·∫øt t·ª± ƒë·ªông ƒëi·ªÅn</h4>
                        <p>ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin MST ng∆∞·ªùi b√°n v√† m√£ tra c·ª©u (n·∫øu c√≥).</p>
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="${autoFillUrl}" target="_blank" class="direct-pdf-link">
                                üöÄ M·ªü trang v·ªõi th√¥ng tin ƒë√£ ƒëi·ªÅn
                            </a>
                        </div>
                        <p style="margin-top: 10px; font-size: 12px; color: #666;">
                            <em>MST ng∆∞·ªùi b√°n: ${sellerTaxCode || 'Kh√¥ng c√≥'} | M√£ tra c·ª©u: ${lookupCode || 'Kh√¥ng c√≥'}</em>
                        </p>
                    `;
                } else if (autoFillUrl) {
                    infoContent += `
                        <h4>üîó Li√™n k·∫øt tra c·ª©u</h4>
                        <p>Truy c·∫≠p trang tra c·ª©u c·ªßa nh√† cung c·∫•p.</p>
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="${autoFillUrl}" target="_blank" class="direct-pdf-link">
                                üîç M·ªü trang tra c·ª©u ${selectedOption.getAttribute('data-provider-name')}
                            </a>
                        </div>
                    `;
                }
                
                if (pdfDownloadInfo && pdfDownloadInfo.requiresCode && !lookupCode) {
                    infoContent += `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h4>‚ÑπÔ∏è C·∫ßn m√£ tra c·ª©u</h4>
                            <p>Nh√† cung c·∫•p <strong>${pdfDownloadInfo.provider.name}</strong> h·ªó tr·ª£ t·∫£i PDF tr·ª±c ti·∫øp nh∆∞ng y√™u c·∫ßu m√£ tra c·ª©u.</p>
                        </div>
                    `;
                }
                
                infoContent += `<p style="margin-top: 10px; font-size: 12px; color: #666;">
                    <em>Li√™n k·∫øt n√†y s·∫Ω m·ªü trong tab m·ªõi</em>
                </p>`;
                
                directPdfInfo.innerHTML = infoContent;
                directPdfInfo.style.display = 'block';
                
                // ·∫®n √¥ nh·∫≠p m√£ tra c·ª©u n·∫øu ƒë√£ c√≥ ƒë·ªß th√¥ng tin
                if ((pdfDownloadInfo && pdfDownloadInfo.pdfUrl) || specialLookupUrl || autoFillUrl) {
                    document.getElementById('lookupCodeGroup').style.display = 'none';
                } else {
                    document.getElementById('lookupCodeGroup').style.display = 'block';
                }
            } else {
                // Kh√¥ng h·ªó tr·ª£ t·∫£i tr·ª±c ti·∫øp
                directPdfInfo.style.display = 'none';
                document.getElementById('lookupCodeGroup').style.display = 'block';
            }
            
            // L∆∞u th√¥ng tin nh√† cung c·∫•p hi·ªán t·∫°i
            if (selectedOption) {
                currentSelectedProvider = {
                    mst: providerMST,
                    name: selectedOption.getAttribute('data-provider-name'),
                    url: selectedOption.getAttribute('data-url')
                };
            }
        });

        // Th·ª±c hi·ªán tra c·ª©u - ƒê√É ƒê∆Ø·ª¢C S·ª¨A
        document.getElementById('performLookupBtn').addEventListener('click', function() {
            const providerSelect = document.getElementById('providerSelect');
            const selectedOption = providerSelect.options[providerSelect.selectedIndex];
            const providerMST = providerSelect.value;
            const providerName = selectedOption.getAttribute('data-provider-name');
            const providerUrl = selectedOption.getAttribute('data-url');
            const lookupCode = document.getElementById('lookupCode').value.trim();
            const transactionID = invoiceData.transactionID;
            const sellerTaxCode = invoiceData.sellerTaxCode;
            const lookupResult = document.getElementById('lookupResult');
            const providerDetails = document.getElementById('providerDetails');
            const directLookupSection = document.getElementById('directLookupSection');
            
            if (!providerMST) {
                lookupResult.textContent = "Vui l√≤ng ch·ªçn nh√† cung c·∫•p!";
                lookupResult.className = 'lookup-result lookup-error';
                lookupResult.style.display = 'block';
                return;
            }
            
            // Y√äU C·∫¶U 3: N·∫øu MSTTCGP tr√πng v·ªõi function th√¨ l·∫•y link t·ª´ function
            let pdfDownloadInfo = null;
            
            if (providerMST === MISA_FUNCTION.mst) {
                // Function MISA
                const misaResult = MISA_FUNCTION.processXml(invoiceData.xmlContent);
                if (misaResult.success) {
                    pdfDownloadInfo = {
                        provider: MISA_FUNCTION,
                        pdfUrl: misaResult.data.pdfUrl,
                        requiresCode: false,
                        autoFillSupported: true
                    };
                }
            } else if (providerMST === BKAV_FUNCTION.id) {
                // Function BKAV
                const bkavResult = BKAV_FUNCTION.generateFromXML(invoiceData.xmlContent);
                if (bkavResult.success) {
                    pdfDownloadInfo = {
                        provider: BKAV_FUNCTION,
                        pdfUrl: bkavResult.data.downloadLink,
                        requiresCode: false,
                        autoFillSupported: true
                    };
                }
            } else if (providerMST === VIENH_HY_FUNCTION.mst) {
                // Function Vƒ©nh Hy
                const vinhHyResult = VIENH_HY_FUNCTION.processXml(invoiceData.xmlContent);
                if (vinhHyResult.success) {
                    pdfDownloadInfo = {
                        provider: VIENH_HY_FUNCTION,
                        pdfUrl: vinhHyResult.data.pdfUrl,
                        requiresCode: false,
                        autoFillSupported: true
                    };
                }
            } else if (providerMST === EASYINVOICE_MODULE.mst) {
                // Module EasyInvoice
                const jsonData = loadJsonFromStorage();
                if (jsonData) {
                    const easyInvoiceResult = createEasyInvoiceLookupURL(jsonData);
                    if (easyInvoiceResult.success) {
                        pdfDownloadInfo = {
                            provider: EASYINVOICE_MODULE,
                            pdfUrl: easyInvoiceResult.lookupUrl,
                            requiresCode: false,
                            autoFillSupported: true
                        };
                    }
                }
            } else {
                // C√°c nh√† cung c·∫•p kh√°c - Y√äU C·∫¶U 4
                pdfDownloadInfo = checkDirectPdfDownloadSupport(providerMST, lookupCode);
            }
            
            // Ki·ªÉm tra URL tra c·ª©u ƒë·∫∑c bi·ªát
            const specialLookupUrl = createSpecialLookupUrl(providerMST, transactionID, sellerTaxCode, lookupCode);
            
            // T·∫°o URL t·ª± ƒë·ªông ƒëi·ªÅn
            const autoFillUrl = createAutoFillUrl(providerMST, sellerTaxCode, lookupCode, transactionID);
            
            // Hi·ªÉn th·ªã th√¥ng tin nh√† cung c·∫•p
            providerDetails.innerHTML = `
                <h4>Th√¥ng tin nh√† cung c·∫•p gi·∫£i ph√°p:</h4>
                <p><strong>T√™n ƒë∆°n v·ªã:</strong> ${providerName}</p>
                <p><strong>M√£ s·ªë thu·∫ø:</strong> ${providerMST}</p>
                <p><strong>URL tra c·ª©u:</strong> <a href="${providerUrl}" target="_blank">${providerUrl}</a></p>
            `;
            providerDetails.style.display = 'block';
            
            // T·∫°o c√°c li√™n k·∫øt tra c·ª©u tr·ª±c ti·∫øp
            let directLookupLinks = '';
            
            if (pdfDownloadInfo && pdfDownloadInfo.pdfUrl) {
                directLookupLinks += `<a href="${pdfDownloadInfo.pdfUrl}" target="_blank" class="direct-lookup-btn">üì• T·∫£i PDF tr·ª±c ti·∫øp</a>`;
            }
            
            if (specialLookupUrl) {
                directLookupLinks += `<a href="${specialLookupUrl}" target="_blank" class="direct-lookup-btn">üîó Tra c·ª©u ƒë·∫∑c bi·ªát</a>`;
            }
            
            if (autoFillUrl) {
                if (pdfDownloadInfo && pdfDownloadInfo.autoFillSupported) {
                    directLookupLinks += `<a href="${autoFillUrl}" target="_blank" class="direct-lookup-btn">üöÄ T·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin</a>`;
                } else {
                    directLookupLinks += `<a href="${autoFillUrl}" target="_blank" class="direct-lookup-btn">üîç M·ªü trang tra c·ª©u</a>`;
                }
            }
            
            // Th√™m li√™n k·∫øt ƒë·∫øn trang tra c·ª©u c·ªßa nh√† cung c·∫•p
            if (!autoFillUrl) {
                directLookupLinks += `<a href="${providerUrl}" target="_blank" class="direct-lookup-btn">üîç M·ªü trang tra c·ª©u</a>`;
            }
            
            // Hi·ªÉn th·ªã ph·∫ßn tra c·ª©u tr·ª±c ti·∫øp
            directLookupSection.innerHTML = `
                <h4>Tra c·ª©u tr·ª±c ti·∫øp:</h4>
                <p>Nh·∫•n v√†o li√™n k·∫øt d∆∞·ªõi ƒë√¢y ƒë·ªÉ m·ªü trang tra c·ª©u ho·∫∑c t·∫£i PDF tr·ª±c ti·∫øp:</p>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">${directLookupLinks}</div>
            `;
            directLookupSection.style.display = 'block';
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£ tra c·ª©u
            let resultMessage = '';
            
            if (pdfDownloadInfo && pdfDownloadInfo.pdfUrl) {
                resultMessage = `
                    <h4>‚úÖ C√≥ th·ªÉ t·∫£i PDF tr·ª±c ti·∫øp!</h4>
                    <p>M√£ tra c·ª©u c·ªßa b·∫°n: <strong>${lookupCode || 'Kh√¥ng c·∫ßn m√£'}</strong></p>
                    <p>MST ng∆∞·ªùi b√°n: <strong>${sellerTaxCode || 'Kh√¥ng c√≥'}</strong></p>
                    <p>Nh√† cung c·∫•p: <strong>${providerName}</strong></p>
                    <p>B·∫°n c√≥ th·ªÉ t·∫£i PDF tr·ª±c ti·∫øp b·∫±ng li√™n k·∫øt b√™n tr√™n.</p>
                `;
                
                // C·∫≠p nh·∫≠t link tra c·ª©u ·ªü footer
                updateFooterLookupLink(pdfDownloadInfo.pdfUrl, providerName);
            } else if (specialLookupUrl) {
                resultMessage = `
                    <h4>üîó Li√™n k·∫øt tra c·ª©u ƒë·∫∑c bi·ªát</h4>
                    <p>Transaction ID: <strong>${transactionID || 'Kh√¥ng c√≥'}</strong></p>
                    <p>MST ng∆∞·ªùi b√°n: <strong>${sellerTaxCode || 'Kh√¥ng c√≥'}</strong></p>
                    <p>Nh√† cung c·∫•p: <strong>${providerName}</strong></p>
                    <p>ƒê√£ t·∫°o li√™n k·∫øt tra c·ª©u ƒë·∫∑c bi·ªát cho nh√† cung c·∫•p n√†y.</p>
                `;
                
                // C·∫≠p nh·∫≠t link tra c·ª©u ·ªü footer
                updateFooterLookupLink(specialLookupUrl, providerName);
            } else if (autoFillUrl) {
                resultMessage = `
                    <h4>ü§ñ ƒê√£ t·∫°o li√™n k·∫øt t·ª± ƒë·ªông ƒëi·ªÅn</h4>
                    <p>MST ng∆∞·ªùi b√°n: <strong>${sellerTaxCode || 'Kh√¥ng c√≥'}</strong></p>
                    <p>M√£ tra c·ª©u: <strong>${lookupCode || 'Kh√¥ng c√≥'}</strong></p>
                    <p>Nh√† cung c·∫•p: <strong>${providerName}</strong></p>
                    <p>Li√™n k·∫øt ƒë√£ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin v√†o trang tra c·ª©u.</p>
                `;
                
                // C·∫≠p nh·∫≠t link tra c·ª©u ·ªü footer
                updateFooterLookupLink(autoFillUrl, providerName);
            } else if (lookupCode) {
                resultMessage = `
                    <h4>Th√¥ng tin tra c·ª©u:</h4>
                    <p>M√£ tra c·ª©u c·ªßa b·∫°n: <strong>${lookupCode}</strong></p>
                    <p>MST ng∆∞·ªùi b√°n: <strong>${sellerTaxCode || 'Kh√¥ng c√≥'}</strong></p>
                    <p>Nh√† cung c·∫•p: <strong>${providerName}</strong></p>
                    <p>Vui l√≤ng nh·∫≠p m√£ n√†y v√†o trang tra c·ª©u c·ªßa nh√† cung c·∫•p ƒë·ªÉ t·∫£i h√≥a ƒë∆°n PDF.</p>
                `;
            } else {
                resultMessage = `
                    <h4>Th√¥ng tin nh√† cung c·∫•p:</h4>
                    <p>MST ng∆∞·ªùi b√°n: <strong>${sellerTaxCode || 'Kh√¥ng c√≥'}</strong></p>
                    <p>Nh√† cung c·∫•p: <strong>${providerName}</strong></p>
                    <p>M·ªôt s·ªë nh√† cung c·∫•p kh√¥ng y√™u c·∫ßu m√£ tra c·ª©u. Vui l√≤ng th·ª≠ truy c·∫≠p trang tra c·ª©u tr·ª±c ti·∫øp.</p>
                `;
            }
            
            lookupResult.innerHTML = resultMessage;
            lookupResult.className = 'lookup-result lookup-success';
            lookupResult.style.display = 'block';
        });

        // ƒê√≥ng modal tra c·ª©u
        document.getElementById('closeLookupModalBtn').addEventListener('click', closeLookupModal);
        document.getElementById('closeLookupModalBtn2').addEventListener('click', closeLookupModal);
        
        function closeLookupModal() {
            document.getElementById('lookupModal').style.display = 'none';
            document.getElementById('lookupResult').style.display = 'none';
            document.getElementById('lookupResult').className = 'lookup-result';
            document.getElementById('providerDetails').style.display = 'none';
            document.getElementById('directLookupSection').style.display = 'none';
            document.getElementById('directPdfInfo').style.display = 'none';
            document.getElementById('lookupCodeGroup').style.display = 'block';
        }

        // ==============================================
        // H√ÄM C·∫¨P NH·∫¨T FOOTER - ƒê√É ƒê∆Ø·ª¢C TH√äM
        // ==============================================

        // H√†m c·∫≠p nh·∫≠t link tra c·ª©u ·ªü footer
        function updateFooterLookupLink(link, providerName) {
            const footerLookupLink = document.getElementById('footerLookupLink');
            currentLookupLink = link;
            
            footerLookupLink.innerHTML = `
                <strong>üîó Link tra c·ª©u t·ª´ ${providerName}:</strong><br>
                <a href="${link}" target="_blank" style="color: #ffffff; text-decoration: underline; word-break: break-all;">
                    ${link}
                </a>
                <br>
                <small style="opacity: 0.8;">(Nh·∫•n v√†o link ƒë·ªÉ m·ªü trong tab m·ªõi)</small>
            `;
            
            // Th√™m hi·ªáu ·ª©ng ƒë·ªÉ thu h√∫t s·ª± ch√∫ √Ω
            const footerLookupInfo = document.getElementById('footerLookupInfo');
            footerLookupInfo.style.animation = 'pulse 1s ease-in-out';
            setTimeout(() => {
                footerLookupInfo.style.animation = '';
            }, 1000);
            
            console.log(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t link tra c·ª©u ·ªü footer: ${link}`);
        }

        // ==============================================
        // KH·ªûI T·∫†O V√Ä C√ÅC H√ÄM CHUNG
        // ==============================================

        // X·ª≠ l√Ω tab ch√≠nh
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // X√≥a active class t·ª´ t·∫•t c·∫£ c√°c tab v√† n·ªôi dung
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Th√™m active class cho tab ƒë∆∞·ª£c ch·ªçn
                this.classList.add('active');
                
                // Hi·ªÉn th·ªã n·ªôi dung t∆∞∆°ng ·ª©ng
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Hi·ªÉn th·ªã danh s√°ch MSTTCGP ·ªü footer
        function displayMSTTCGPList() {
            const msttcgpList = document.getElementById('msttcgpList');
            
            // T·∫°o danh s√°ch c√°c function ch√≠nh
            const mainFunctions = [
                { mst: VIENH_HY_FUNCTION.mst, name: VIENH_HY_FUNCTION.name },
                { mst: MISA_FUNCTION.mst, name: MISA_FUNCTION.name },
                { mst: BKAV_FUNCTION.id, name: BKAV_FUNCTION.name },
                { mst: EASYINVOICE_MODULE.mst, name: EASYINVOICE_MODULE.name }
            ];
            
            // Th√™m c√°c function ch√≠nh
            mainFunctions.forEach(func => {
                const item = document.createElement('div');
                item.className = 'msttcgp-item msttcgp-module';
                item.textContent = `${func.mst} - ${func.name}`;
                msttcgpList.appendChild(item);
            });
            
            // Th√™m m·ªôt s·ªë nh√† cung c·∫•p kh√°c
            const otherProviders = serviceProviders.slice(0, 10); // L·∫•y 10 nh√† cung c·∫•p ƒë·∫ßu ti√™n
            otherProviders.forEach(provider => {
                // B·ªè qua c√°c function ƒë√£ th√™m
                if (!mainFunctions.some(func => func.mst === provider.mst)) {
                    const item = document.createElement('div');
                    item.className = 'msttcgp-item';
                    item.textContent = `${provider.mst} - ${provider.name}`;
                    msttcgpList.appendChild(item);
                }
            });
        }

        // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', function() {
            // Kh·ªüi t·∫°o danh s√°ch nh√† cung c·∫•p
            initializeProviders();
            
            // Hi·ªÉn th·ªã danh s√°ch MSTTCGP
            displayMSTTCGPList();
            
            // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu JSON trong localStorage kh√¥ng - Y√äU C·∫¶U 1
            const jsonData = loadJsonFromStorage();
            if (jsonData) {
                console.log('ƒê√£ t√¨m th·∫•y d·ªØ li·ªáu JSON trong localStorage, ƒëang kh√¥i ph·ª•c...');
                
                // Kh√¥i ph·ª•c d·ªØ li·ªáu t·ª´ JSON - Y√äU C·∫¶U 1 & 8
                invoiceData = jsonData.processedData || {};
                
                // T√¨m nh√† cung c·∫•p ph√π h·ª£p d·ª±a tr√™n MSTTCGP - Y√äU C·∫¶U 2
                matchedProviders = findMatchingProviders(invoiceData.serviceProviderTaxCode);
                
                console.log('ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu t·ª´ JSON th√†nh c√¥ng');
            }
            
            console.log('C√¥ng c·ª• chuy·ªÉn ƒë·ªïi h√≥a ƒë∆°n ƒëi·ªán t·ª≠ ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o');
            console.log('Function Vƒ©nh Hy:', VIENH_HY_FUNCTION);
            console.log('Function MISA:', MISA_FUNCTION);
            console.log('Function BKAV:', BKAV_FUNCTION);
            console.log('Module EasyInvoice:', EASYINVOICE_MODULE);
        });
    </script>
</body>
</html>
